/**
 * @file Firestore Security Rules for ExamplifyAI
 * @version Prototyping Mode - Data shape is not strictly validated.
 *
 * @description This ruleset enforces a user-ownership model for personal data and
 * provides public read access to certain collections while restricting write access
 * to authorized users.  It assumes roles are stored directly in the `User` document.
 *
 * @dataStructure
 * - /users/{userId}: Stores individual user profiles.  Only the user can read/write their own profile.
 * - /courses/{courseId}: Stores course information. Publicly readable.  Write access to authorized users.
 * - /lessons/{lessonId}: Stores lesson information. Publicly readable. Write access to authorized users.
 * - /questions/{questionId}: Stores questions for exams and quizzes. Publicly readable. Write access to authorized users.
 * - /exams/{examId}: Stores exam definitions. Publicly readable. Write access to authorized users.
 * - /attempts/{attemptId}: Stores user exam attempts. Publicly readable.  Write access to authorized users.
 * - /metrics/daily/{date}: Stores daily metrics. Publicly readable.  Write access to authorized users.
 * - /courseCompetencies/{courseCompetencyId}: Stores course competencies. Publicly readable. Write access to authorized users.
 * - /users/{userId}/achievements/{userAchievementId}: Stores user achievements. Only the user can read/write their own achievements.
 * - /masterCourses/{masterCourseId}: Stores master course definitions. Publicly readable. Write access to authorized users.
 * - /masterCertificates/{masterCertificateId}: Stores issued master certificates. Publicly readable.  Write access to authorized users.
 * - /roadmaps/{roadmapId}: Stores roadmap definitions. Publicly readable. Write access to authorized users.
 * - /schedules/{scheduleId}: Stores schedule events. Publicly readable. Write access to authorized users.
 * - /quizzes/{quizId}: Stores quiz information. Publicly readable.  Write access to authorized users.
 *
 * @keySecurityDecisions
 * - Users can only read and write their own user document and achievements.
 * - Listing of users is disallowed to prevent enumeration.
 * - Other collections are publicly readable, but write access is restricted.
 * - Data validation is minimal, focusing on authorization and relationship integrity in `create` and `update` operations, as part of the Prototyping Mode.
 * - No write operations are completely open, and all destructive operations check for resource existence.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by the authenticated user.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Authentication.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Authorization.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId and the resource exists.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Existence and Authorization.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces user-ownership for user profiles.
     * @path /users/{userId}
     * @allow (create) User with auth UID 'user_abc' can create their profile at /users/user_abc.
     * @allow (get, update, delete) User with auth UID 'user_abc' can access their profile at /users/user_abc.
     * @deny (create) User with auth UID 'user_abc' cannot create a profile at /users/user_xyz.
     * @deny (get, update, delete) User with auth UID 'user_abc' cannot access the profile at /users/user_xyz.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to courses and restricts write access.
     * @path /courses/{courseId}
     * @allow (get, list) Any user can read course data.
     * @deny (create, update, delete) Only authenticated users can modify course data (but no specific validation is done in this prototype).
     * @principle Provides public read access with restricted writes.
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows public read access to lessons and restricts write access.
     * @path /lessons/{lessonId}
     * @allow (get, list) Any user can read lesson data.
     * @deny (create, update, delete) Only authenticated users can modify lesson data (but no specific validation is done in this prototype).
     * @principle Provides public read access with restricted writes.
     */
    match /lessons/{lessonId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows public read access to questions and restricts write access.
     * @path /questions/{questionId}
     * @allow (get, list) Any user can read question data.
     * @deny (create, update, delete) Only authenticated users can modify question data (but no specific validation is done in this prototype).
     * @principle Provides public read access with restricted writes.
     */
    match /questions/{questionId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows public read access to exams and restricts write access.
     * @path /exams/{examId}
     * @allow (get, list) Any user can read exam data.
     * @deny (create, update, delete) Only authenticated users can modify exam data (but no specific validation is done in this prototype).
     * @principle Provides public read access with restricted writes.
     */
    match /exams/{examId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows public read access to attempts and restricts write access.
     * @path /attempts/{attemptId}
     * @allow (get, list) Any user can read attempt data.
     * @deny (create, update, delete) Only authenticated users can modify attempt data (but no specific validation is done in this prototype).
     * @principle Provides public read access with restricted writes.
     */
    match /attempts/{attemptId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows public read access to daily metrics and restricts write access.
     * @path /metrics/daily/{date}
     * @allow (get, list) Any user can read daily metrics data.
     * @deny (create, update, delete) Only authenticated users can modify daily metrics data (but no specific validation is done in this prototype).
     * @principle Provides public read access with restricted writes.
     */
    match /metrics/daily/{date} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows public read access to course competencies and restricts write access.
     * @path /courseCompetencies/{courseCompetencyId}
     * @allow (get, list) Any user can read course competency data.
     * @deny (create, update, delete) Only authenticated users can modify course competency data (but no specific validation is done in this prototype).
     * @principle Provides public read access with restricted writes.
     */
    match /courseCompetencies/{courseCompetencyId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Enforces user-ownership for user achievements.
     * @path /users/{userId}/achievements/{userAchievementId}
     * @allow (create) User with auth UID 'user_abc' can create an achievement at /users/user_abc/achievements/achievement_1.
     * @allow (get, update, delete) User with auth UID 'user_abc' can access their achievement at /users/user_abc/achievements/achievement_1.
     * @deny (create) User with auth UID 'user_abc' cannot create an achievement at /users/user_xyz/achievements/achievement_1.
     * @deny (get, update, delete) User with auth UID 'user_abc' cannot access the achievement at /users/user_xyz/achievements/achievement_1.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/achievements/{userAchievementId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to master courses and restricts write access.
     * @path /masterCourses/{masterCourseId}
     * @allow (get, list) Any user can read master course data.
     * @deny (create, update, delete) Only authenticated users can modify master course data (but no specific validation is done in this prototype).
     * @principle Provides public read access with restricted writes.
     */
    match /masterCourses/{masterCourseId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows public read access to master certificates and restricts write access.
     * @path /masterCertificates/{masterCertificateId}
     * @allow (get, list) Any user can read master certificate data.
     * @deny (create, update, delete) Only authenticated users can modify master certificate data (but no specific validation is done in this prototype).
     * @principle Provides public read access with restricted writes.
     */
    match /masterCertificates/{masterCertificateId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows public read access to roadmaps and restricts write access.
     * @path /roadmaps/{roadmapId}
     * @allow (get, list) Any user can read roadmap data.
     * @deny (create, update, delete) Only authenticated users can modify roadmap data (but no specific validation is done in this prototype).
     * @principle Provides public read access with restricted writes.
     */
    match /roadmaps/{roadmapId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows public read access to schedules and restricts write access.
     * @path /schedules/{scheduleId}
     * @allow (get, list) Any user can read schedule data.
     * @deny (create, update, delete) Only authenticated users can modify schedule data (but no specific validation is done in this prototype).
     * @principle Provides public read access with restricted writes.
     */
    match /schedules/{scheduleId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Allows public read access to quizzes and restricts write access.
     * @path /quizzes/{quizId}
     * @allow (get, list) Any user can read quiz data.
     * @deny (create, update, delete) Only authenticated users can modify quiz data (but no specific validation is done in this prototype).
     * @principle Provides public read access with restricted writes.
     */
    match /quizzes/{quizId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }
  }
}