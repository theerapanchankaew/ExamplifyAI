/**
 * @fileoverview Firestore Security Rules for ExamplifyAI.
 *
 * Core Philosophy:
 * This ruleset prioritizes user data protection and enforces a strict ownership model
 * for user-specific data while allowing public read access to general content.
 *
 * Data Structure:
 * - User profiles are stored under `/users/{userId}`, where `userId` MUST match the authenticated user's UID.
 * - User-specific data (e.g., achievements) is nested under the respective `/users/{userId}` document.
 * - General content (e.g., courses, lessons, questions) is stored in top-level collections.
 * - Daily metrics are stored under `/metrics/daily/{date}`.
 *
 * Key Security Decisions:
 * - User listing is disabled to protect user privacy.
 * - Public read access is granted for general content collections (e.g., courses, lessons, questions).
 * - User-specific subcollections (e.g., achievements) are strictly limited to owner access.
 * - Data consistency between the path and the document's internal `userId` field is enforced on creation and updates for user-specific documents.
 * - Write operations on root-level documents require authentication (i.e., no anonymous writes).
 *
 * Denormalization for Authorization:
 *  - The `Attempt` entity stores both the `userId` and `examId`, allowing direct access control without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     * @param {string} userId - The user ID to compare against the authenticated user's UID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of an existing document.
     * @param {string} userId - The user ID to compare against the authenticated user's UID.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own profile if the userId matches their auth UID.
     * @allow (get, update, delete) - Authenticated user can only access their own profile.
     * @deny (create) - Anonymous user can not create a profile.
     * @deny (get, update, delete) - Another authenticated user cannot access this profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // User listing is disabled.
      allow create: if isOwner(userId) && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId; // userId is immutable.
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for courses.
     * @path /courses/{courseId}
     * @allow (get, list) - Anyone can read course information.
     * @deny (create, update, delete) - Only authenticated users can create, update, or delete courses.
     * @principle Public read with owner-only writes.
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for lessons.
     * @path /lessons/{lessonId}
     * @allow (get, list) - Anyone can read lesson information.
     * @deny (create, update, delete) - Only authenticated users can create, update, or delete lessons.
     * @principle Public read with owner-only writes.
     */
    match /lessons/{lessonId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for questions.
     * @path /questions/{questionId}
     * @allow (get, list) - Anyone can read question information.
     * @deny (create, update, delete) - Only authenticated users can create, update, or delete questions.
     * @principle Public read with owner-only writes.
     */
    match /questions/{questionId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for exams.
     * @path /exams/{examId}
     * @allow (get, list) - Anyone can read exam information.
     * @deny (create, update, delete) - Only authenticated users can create, update, or delete exams.
     * @principle Public read with owner-only writes.
     */
    match /exams/{examId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for attempts.
     * @path /attempts/{attemptId}
     * @allow (get, list) - Anyone can read attempt information.
     * @deny (create, update, delete) - Only authenticated users can create, update, or delete attempts.
     * @principle Public read with owner-only writes.
     */
    match /attempts/{attemptId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for daily metrics.
     * @path /metrics/daily/{date}
     * @allow (get, list) - Anyone can read daily metrics.
     * @deny (create, update, delete) - No one can create, update, or delete daily metrics.
     * @principle Public read, no writes allowed.
     */
    match /metrics/daily/{date} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for course competencies.
     * @path /courseCompetencies/{courseCompetencyId}
     * @allow (get, list) - Anyone can read course competency information.
     * @deny (create, update, delete) - Only authenticated users can create, update, or delete course competencies.
     * @principle Public read with owner-only writes.
     */
    match /courseCompetencies/{courseCompetencyId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for user achievements.
     * @path /users/{userId}/achievements/{userAchievementId}
     * @allow (create) - Authenticated user can create their own achievement if the userId matches their auth UID.
     * @allow (get, list, update, delete) - Authenticated user can only access their own achievements.
     * @deny (create) - Anonymous user can not create an achievement.
     * @deny (get, list, update, delete) - Another authenticated user cannot access this achievement.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/achievements/{userAchievementId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for master courses.
     * @path /masterCourses/{masterCourseId}
     * @allow (get, list) - Anyone can read master course information.
     * @deny (create, update, delete) - Only authenticated users can create, update, or delete master courses.
     * @principle Public read with owner-only writes.
     */
    match /masterCourses/{masterCourseId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for master certificates.
     * @path /masterCertificates/{masterCertificateId}
     * @allow (get, list) - Anyone can read master certificate information.
     * @deny (create, update, delete) - Only authenticated users can create, update, or delete master certificates.
     * @principle Public read with owner-only writes.
     */
    match /masterCertificates/{masterCertificateId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for roadmaps.
     * @path /roadmaps/{roadmapId}
     * @allow (get, list) - Anyone can read roadmap information.
     * @deny (create, update, delete) - Only authenticated users can create, update, or delete roadmaps.
     * @principle Public read with owner-only writes.
     */
    match /roadmaps/{roadmapId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for schedules.
     * @path /schedules/{scheduleId}
     * @allow (get, list) - Anyone can read schedule information.
     * @deny (create, update, delete) - Only authenticated users can create, update, or delete schedules.
     * @principle Public read with owner-only writes.
     */
    match /schedules/{scheduleId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

     /**
      * @description Rules for quizzes.
      * @path /quizzes/{quizId}
      * @allow (get, list) - Anyone can read quiz information.
      * @deny (create, update, delete) - Only authenticated users can create, update, or delete quizzes.
      * @principle Public read with owner-only writes.
      */
    match /quizzes/{quizId} {
        allow get, list: if true;
        allow create: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
        allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
        allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }
  }
}