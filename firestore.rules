/**
 * @fileoverview Firestore Security Rules for ExamplifyAI.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and achievements.
 * Exam attempts are also secured by user ownership.
 * Other data (courses, lessons, questions, etc.) is generally open for read access, with write access restricted.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, `userId` must match `auth.uid`.
 * - /users/{userId}/achievements/{achievementId}: User-specific achievements.
 * - /courses/{courseId}: Course information.
 * - /lessons/{lessonId}: Lesson information.
 * - /questions/{questionId}: Question bank.
 * - /exams/{examId}: Exam definitions.
 * - /attempts/{attemptId}: User exam attempts.
 * - /metrics/daily/{date}: Daily metrics.
 * - /courseCompetencies/{courseCompetencyId}: Course-competency mappings.
 * - /masterCourses/{masterCourseId}: Master course definitions.
 * - /masterCertificates/{masterCertificateId}: Master certificates.
 * - /roadmaps/{roadmapId}: Roadmap definitions.
 * - /schedules/{scheduleId}: Schedule events.
 * - /quizzes/{quizId}: Quiz information.
 *
 * Key Security Decisions:
 * - Users can only read/write their own profile data and achievements.
 * - Listing of attempts is disallowed for all users, as the error indicates missing permissions and the current security posture should be more strict.
 * - Other top-level collections (courses, lessons, questions, exams) are publicly readable, with write access implicitly denied or secured as needed.
 *
 * Denormalization for Authorization:
 *  - The 'Attempt' document has a 'userId' field for directly enforcing user ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own profile data.
     * @path /users/{userId}
     * @allow (create, update, delete, get, list) if request.auth.uid == userId
     * @deny (create, update, delete) if request.auth.uid != userId
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if true;
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Allows public read access to course information.
     * @path /courses/{courseId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access to course information.
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to lesson information.
     * @path /lessons/{lessonId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access to lesson information.
     */
    match /lessons/{lessonId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to question bank.
     * @path /questions/{questionId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access to question bank.
     */
    match /questions/{questionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to exam definitions.
     * @path /exams/{examId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access to exam definitions.
     */
    match /exams/{examId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows users to read and write their own exam attempts.
     * @path /attempts/{attemptId}
     * @allow (get) if request.auth.uid == resource.data.userId
     * @deny (list) Always deny listing attempts for all users.
     * @allow (create) if request.auth.uid == request.resource.data.userId
     * @allow (update, delete) if request.auth.uid == resource.data.userId
     * @principle Enforces document ownership for exam attempts.
     */
    match /attempts/{attemptId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isOwner(resource.data.userId);
      allow list: if false; // Disallowing listing due to the error.
      allow create: if isOwner(request.resource.data.userId);
      allow update: if isOwner(resource.data.userId) && resource != null;
      allow delete: if isOwner(resource.data.userId) && resource != null;
    }

    /**
     * @description Allows public read access to daily metrics.
     * @path /metrics/daily/{date}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access to daily metrics.
     */
    match /metrics/daily/{date} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to course-competency mappings.
     * @path /courseCompetencies/{courseCompetencyId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access to course-competency mappings.
     */
    match /courseCompetencies/{courseCompetencyId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows users to read and write their own achievements.
     * @path /users/{userId}/achievements/{userAchievementId}
     * @allow (create, update, delete, get, list) if request.auth.uid == userId
     * @deny (create, update, delete) if request.auth.uid != userId
     * @principle Enforces document ownership for user achievements.
     */
    match /users/{userId}/achievements/{userAchievementId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource != null;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Allows public read access to master course definitions.
     * @path /masterCourses/{masterCourseId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access to master course definitions.
     */
    match /masterCourses/{masterCourseId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to master certificates.
     * @path /masterCertificates/{masterCertificateId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access to master certificates.
     */
    match /masterCertificates/{masterCertificateId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to roadmap definitions.
     * @path /roadmaps/{roadmapId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access to roadmap definitions.
     */
    match /roadmaps/{roadmapId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to schedule events.
     * @path /schedules/{scheduleId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access to schedule events.
     */
    match /schedules/{scheduleId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to quiz information.
     * @path /quizzes/{quizId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access to quiz information.
     */
    match /quizzes/{quizId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
  }
}