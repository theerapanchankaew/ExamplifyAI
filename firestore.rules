/**
 * @file Firebase Security Rules for ExamplifyAI
 *
 * @core_philosophy This ruleset prioritizes secure access control based on user roles and data ownership.
 *   It enforces a strict model where users can only access their own data unless explicitly granted
 *   broader permissions (e.g., through admin roles). Data validation is relaxed to allow rapid prototyping.
 *
 * @data_structure
 *   - `/users/{userId}`: Stores user profiles. `userId` MUST match the authenticated user's UID.
 *   - `/courses/{courseId}`: Stores course information. Publicly readable.
 *   - `/lessons/{lessonId}`: Stores lesson information, related to a course by `courseId`. Publicly readable.
 *   - `/modules/{moduleId}`: Stores module information, related to a lesson by `lessonId`. Publicly readable.
 *   - `/chapters/{chapterId}`: Stores chapter information, related to a module by `moduleId`. Publicly readable.
 *   - `/questions/{questionId}`: Stores questions for exams and quizzes. Publicly readable.
 *   - `/exams/{examId}`: Stores exam definitions, related to a course by `courseId`. Publicly readable.
 *   - `/attempts/{attemptId}`: Stores user exam attempts, linked to a user by `userId` and an exam by `examId`.
 *   - `/metrics/daily/{date}`: Stores daily metrics for the system. Document ID is the date in YYYYMMDD format.
 *   - `/courseCompetencies/{courseCompetencyId}`: Stores the mapping between courses and competencies. Publicly readable.
 *   - `/users/{userId}/achievements/{userAchievementId}`: Stores user achievements. Accessible only by the user.
 *   - `/masterCourses/{masterCourseId}`: Stores master course definitions. Publicly readable.
 *   - `/masterCertificates/{masterCertificateId}`: Stores issued master certificates, linked to a user by `userId` and a master course by `masterCourseId`.
 *   - `/roadmaps/{roadmapId}`: Stores roadmap definitions. Publicly readable.
 *   - `/schedules/{scheduleId}`: Stores schedule events. Publicly readable.
 *   - `/quizzes/{quizId}`: Stores quiz information. Publicly readable.
 *
 * @key_security_decisions
 *   - User listing is explicitly denied for privacy.
 *   - Public read access is granted to most top-level collections (courses, lessons, etc.) to facilitate open access to learning content.
 *   - Ownership is strictly enforced for user-specific data (e.g., user profiles, attempts, achievements).
 *
 * @denormalization_for_authorization
 *   - No denormalization is explicitly defined, but the rules assume that documents under `/users/{userId}` contain a `userId` field that matches the path.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @return {bool} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     * @param {string} userId The user ID to compare against the authenticated user's UID.
     * @return {bool} True if the UIDs match, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of an existing document.
     * @param {string} userId The user ID of the document's owner.
     * @return {bool} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Security rules for user profiles.
     * @path /users/{userId}
     * @allow (create) - If the user is creating their own profile (userId matches auth.uid).
     * @allow (get, update, delete) - If the user is the owner of the profile.
     * @deny (list) - User listing is not allowed.
     * @deny (create) - If the user tries to create a profile for another user.
     * @principle Enforces user ownership for profile data.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for courses.
     * @path /courses/{courseId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access.
     * @principle Publicly readable collection.
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Security rules for lessons.
     * @path /lessons/{lessonId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access.
     * @principle Publicly readable collection.
     */
    match /lessons/{lessonId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Security rules for modules.
     * @path /modules/{moduleId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access.
     * @principle Publicly readable collection.
     */
    match /modules/{moduleId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Security rules for chapters.
     * @path /chapters/{chapterId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access.
     * @principle Publicly readable collection.
     */
    match /chapters/{chapterId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

     /**
      * @description Security rules for questions.
      * @path /questions/{questionId}
      * @allow (get, list) - Public read access.
      * @deny (create, update, delete) - No write access.
      * @principle Publicly readable collection.
      */
    match /questions/{questionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Security rules for exams.
     * @path /exams/{examId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access.
     * @principle Publicly readable collection.
     */
    match /exams/{examId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Security rules for attempts.
     * @path /attempts/{attemptId}
     * @allow (get) - Allow reads.
     * @allow (list) - Deny listing of all attempts
     * @allow (create) - Allow creation
     * @allow (update, delete) - No writes allowed.
     */
    match /attempts/{attemptId} {
      allow get: if true;
      allow list: if false;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Security rules for daily metrics.
     * @path /metrics/daily/{date}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access.
     * @principle Publicly readable collection.
     */
    match /metrics/daily/{date} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Security rules for course competencies.
     * @path /courseCompetencies/{courseCompetencyId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access.
     * @principle Publicly readable collection.
     */
    match /courseCompetencies/{courseCompetencyId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Security rules for user achievements.
     * @path /users/{userId}/achievements/{userAchievementId}
     * @allow (get, list, create, update, delete) - Only the owner can access their achievements.
     * @deny (create) - If the user tries to create an achievement for another user.
     * @principle Enforces user ownership for achievement data.
     */
    match /users/{userId}/achievements/{userAchievementId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Security rules for master courses.
     * @path /masterCourses/{masterCourseId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access.
     * @principle Publicly readable collection.
     */
    match /masterCourses/{masterCourseId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Security rules for master certificates.
     * @path /masterCertificates/{masterCertificateId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access.
     * @principle Publicly readable collection.
     */
    match /masterCertificates/{masterCertificateId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

     /**
      * @description Security rules for roadmaps.
      * @path /roadmaps/{roadmapId}
      * @allow (get, list) - Public read access.
      * @deny (create, update, delete) - No write access.
      * @principle Publicly readable collection.
      */
    match /roadmaps/{roadmapId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

     /**
      * @description Security rules for schedules.
      * @path /schedules/{scheduleId}
      * @allow (get, list) - Public read access.
      * @deny (create, update, delete) - No write access.
      * @principle Publicly readable collection.
      */
    match /schedules/{scheduleId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Security rules for quizzes.
     * @path /quizzes/{quizId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access.
     * @principle Publicly readable collection.
     */
    match /quizzes/{quizId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
  }
}