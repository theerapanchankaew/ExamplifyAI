/**
 * @file Firestore Security Rules
 * @version 2
 *
 * @Core Philosophy
 * This ruleset prioritizes secure authorization above all else and assumes a rapid prototyping phase.
 * It enforces a strict user-ownership model for user-specific data and public read access where appropriate.
 * Schema validation is intentionally relaxed to enable rapid iteration.
 *
 * @Data Structure
 * - `/users/{userId}`: Stores individual user profiles, with `userId` matching the authenticated user's UID.
 * - Top-level collections (e.g., `/courses`, `/lessons`): Store application-wide data.
 * - User subcollections (e.g., `/users/{userId}/achievements`): Store private user data.
 *
 * @Key Security Decisions
 * - Listing of the `/attempts` collection has been disabled, as listing all attempts is not a desired access pattern and can be a security risk.
 * - User documents (`/users/{userId}`) can only be created by the user themselves (self-creation).
 * - Public read access is granted to top-level collections to facilitate data discovery.
 * - Data validation is minimized to focus on authorization and relational integrity during prototyping.
 *
 * @Denormalization for Authorization
 *  N/A - No denormalization is explicitly used in this version.  However, consider adding `ownerId` fields to documents
 *  in top-level collections for more efficient authorization in the future.
 *
 * @Structural Segregation
 *  Private user data is stored in subcollections under `/users/{userId}`. Public data is stored in top-level collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId and the document exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && exists(resource.data);
    }

    /**
     * @description Enforces that the incoming `id` matches the `userId` in the path.
     */
    function isValidUserId() {
        return request.resource.data.userId == request.auth.uid;
    }

    /**
     * @description
     * - Secures the `/users/{userId}` collection.
     * - Only the authenticated user can read or write their own profile.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (create) User with matching `userId` can create their profile.
     * @allow (get, update, delete) Authenticated user with matching `userId` can read, update, or delete their profile.
     * @deny (create) User with mismatched `userId` cannot create a profile.
     * @deny (get, update, delete) Unauthorized user cannot read, update, or delete another user's profile.
     * @principle Enforces user-ownership for profile management.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description
     * - Secures the `/courses/{courseId}` collection.
     * - Allows public read access (get, list).
     * @path /databases/{database}/documents/courses/{courseId}
     * @allow (get, list) Any user can read course information.
     * @deny (create, update, delete) No one can create, update, or delete courses.
     * @principle Provides public read access to courses.
     */
    match /courses/{courseId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description
     * - Secures the `/lessons/{lessonId}` collection.
     * - Allows public read access (get, list).
     * @path /databases/{database}/documents/lessons/{lessonId}
     * @allow (get, list) Any user can read lesson information.
     * @deny (create, update, delete) No one can create, update, or delete lessons.
     * @principle Provides public read access to lessons.
     */
    match /lessons/{lessonId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description
     * - Secures the `/modules/{moduleId}` collection.
     * - Allows public read access (get, list).
     * @path /databases/{database}/documents/modules/{moduleId}
     * @allow (get, list) Any user can read module information.
     * @deny (create, update, delete) No one can create, update, or delete modules.
     * @principle Provides public read access to modules.
     */
    match /modules/{moduleId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description
     * - Secures the `/chapters/{chapterId}` collection.
     * - Allows public read access (get, list).
     * @path /databases/{database}/documents/chapters/{chapterId}
     * @allow (get, list) Any user can read chapter information.
     * @deny (create, update, delete) No one can create, update, or delete chapters.
     * @principle Provides public read access to chapters.
     */
    match /chapters/{chapterId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description
     * - Secures the `/questions/{questionId}` collection.
     * - Allows public read access (get, list).
     * @path /databases/{database}/documents/questions/{questionId}
     * @allow (get, list) Any user can read question information.
     * @deny (create, update, delete) No one can create, update, or delete questions.
     * @principle Provides public read access to questions.
     */
    match /questions/{questionId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description
     * - Secures the `/exams/{examId}` collection.
     * - Allows public read access (get, list).
     * @path /databases/{database}/documents/exams/{examId}
     * @allow (get, list) Any user can read exam information.
     * @deny (create, update, delete) No one can create, update, or delete exams.
     * @principle Provides public read access to exams.
     */
    match /exams/{examId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description
     * - Secures the `/attempts/{attemptId}` collection.
     * - Listing all attempts is not a desired access pattern and can be a security risk, so listing has been disabled.
     * - Owner can read and write their own attempts.
     * @path /databases/{database}/documents/attempts/{attemptId}
     * @allow (get) Authenticated user with matching `userId` can get their attempt.
     * @deny (list) No one can list all attempts.
     * @allow (create) Authenticated user with matching `userId` can create their attempt.
     * @allow (update, delete) Authenticated user with matching `userId` can update or delete their own attempt.
     * @deny (create, update, delete) Unauthorized user cannot create, update, or delete attempts.
     * @principle Enforces user-ownership for attempt management.
     */
    match /attempts/{attemptId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description
     * - Secures the `/metrics/daily/{date}` collection.
     * - Allows public read access (get, list).
     * @path /databases/{database}/documents/metrics/daily/{date}
     * @allow (get, list) Any user can read daily metrics.
     * @deny (create, update, delete) No one can create, update, or delete daily metrics.
     * @principle Provides public read access to daily metrics.
     */
    match /metrics/daily/{date} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description
     * - Secures the `/courseCompetencies/{courseCompetencyId}` collection.
     * - Allows public read access (get, list).
     * @path /databases/{database}/documents/courseCompetencies/{courseCompetencyId}
     * @allow (get, list) Any user can read course competency information.
     * @deny (create, update, delete) No one can create, update, or delete course competency information.
     * @principle Provides public read access to course competencies.
     */
    match /courseCompetencies/{courseCompetencyId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description
     * - Secures the `/users/{userId}/achievements/{userAchievementId}` collection.
     * - Only the authenticated user can read or write their own achievements.
     * @path /databases/{database}/documents/users/{userId}/achievements/{userAchievementId}
     * @allow (get, list, create, update, delete) Authenticated user with matching `userId` can read, create, update, or delete their achievements.
     * @deny (get, list, create, update, or delete) Unauthorized user cannot read, create, update, or delete another user's achievements.
     * @principle Enforces user-ownership for achievement management.
     */
    match /users/{userId}/achievements/{userAchievementId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description
     * - Secures the `/masterCourses/{masterCourseId}` collection.
     * - Allows public read access (get, list).
     * @path /databases/{database}/documents/masterCourses/{masterCourseId}
     * @allow (get, list) Any user can read master course information.
     * @deny (create, update, delete) No one can create, update, or delete master course information.
     * @principle Provides public read access to master courses.
     */
    match /masterCourses/{masterCourseId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description
     * - Secures the `/masterCertificates/{masterCertificateId}` collection.
     * - Allows public read access (get, list).
     * @path /databases/{database}/documents/masterCertificates/{masterCertificateId}
     * @allow (get, list) Any user can read master certificate information.
     * @deny (create, update, delete) No one can create, update, or delete master certificate information.
     * @principle Provides public read access to master certificates.
     */
    match /masterCertificates/{masterCertificateId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description
     * - Secures the `/roadmaps/{roadmapId}` collection.
     * - Allows public read access (get, list).
     * @path /databases/{database}/documents/roadmaps/{roadmapId}
     * @allow (get, list) Any user can read roadmap information.
     * @deny (create, update, delete) No one can create, update, or delete roadmap information.
     * @principle Provides public read access to roadmaps.
     */
    match /roadmaps/{roadmapId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description
     * - Secures the `/schedules/{scheduleId}` collection.
     * - Allows public read access (get, list).
     * @path /databases/{database}/documents/schedules/{scheduleId}
     * @allow (get, list) Any user can read schedule information.
     * @deny (create, update, delete) No one can create, update, or delete schedule information.
     * @principle Provides public read access to schedules.
     */
    match /schedules/{scheduleId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description
     * - Secures the `/quizzes/{quizId}` collection.
     * - Allows public read access (get, list).
     * @path /databases/{database}/documents/quizzes/{quizId}
     * @allow (get, list) Any user can read quiz information.
     * @deny (create, update, delete) No one can create, update, or delete quiz information.
     * @principle Provides public read access to quizzes.
     */
    match /quizzes/{quizId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}