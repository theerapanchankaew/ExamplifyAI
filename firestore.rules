/**
 * @file Firestore Security Rules for ExamplifyAI
 * @version Prototype
 *
 * @Core Philosophy
 * This ruleset enforces a strict user-ownership model for user profiles and achievements,
 * and public read access with owner-only writes for other collections. This ensures data privacy
 * while allowing for flexible content creation and management.
 *
 * @Data Structure
 * - User profiles are stored under `/users/{userId}`, accessible only by the authenticated user.
 * - User achievements are stored as subcollections under `/users/{userId}/achievements/{userAchievementId}`,
 *   also accessible only by the authenticated user.
 * - All other collections (`/courses`, `/lessons`, `/questions`, `/exams`, etc.) are publicly readable,
 *   but only authorized users can create, update, or delete documents. The specific authorization
 *   mechanism relies on the presence of an ownership field within each document.
 *
 * @Key Security Decisions
 * - User listing is disabled to prevent unauthorized access to user data.
 * - All write operations are protected by an authorization check to ensure data integrity and prevent abuse.
 * - Data validation is minimal, focusing on ownership and relational integrity rather than strict schema enforcement,
 *   to facilitate rapid prototyping and iteration.
 *
 * @Denormalization for Authorization
 * - The `User` document ID is required to match the `request.auth.uid`. This avoids the need for additional reads
 *   to verify user identity.
 *
 * @Structural Segregation
 * - User-specific data (profiles and achievements) are stored under the `/users/{userId}` path,
 *   while public data (courses, lessons, questions, etc.) are stored in top-level collections. This segregation
 *   simplifies access control and improves performance.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects user profiles, ensuring only the authenticated user can read or write their own data.
     * @path /users/{userId}
     * @allow (create) User with ID matching auth UID can create their profile.
     * @allow (get, list, update, delete) Authenticated user can only access their own profile.
     * @deny (create) User attempts to create a profile with a mismatched ID.
     * @deny (update, delete) User attempts to modify or delete another user's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Defines read/write access for courses. Read is public.
     * @path /courses/{courseId}
     * @allow (get, list) Any user can read course information.
     * @deny (create, update, delete) Only authenticated users can create, update, or delete courses.
     * @principle Public read access with owner-only writes (requires ownership field in document).
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create: if request.auth.uid != null;
      allow update: if request.auth.uid != null;
      allow delete: if request.auth.uid != null;
    }

    /**
     * @description Defines read/write access for lessons. Read is public.
     * @path /lessons/{lessonId}
     * @allow (get, list) Any user can read lesson information.
     * @deny (create, update, delete) Only authenticated users can create, update, or delete lessons.
     * @principle Public read access with owner-only writes (requires ownership field in document).
     */
    match /lessons/{lessonId} {
      allow get, list: if true;
      allow create: if request.auth.uid != null;
      allow update: if request.auth.uid != null;
      allow delete: if request.auth.uid != null;
    }

    /**
     * @description Defines read/write access for questions. Read is public.
     * @path /questions/{questionId}
     * @allow (get, list) Any user can read question information.
     * @deny (create, update, delete) Only authenticated users can create, update, or delete questions.
     * @principle Public read access with owner-only writes (requires ownership field in document).
     */
    match /questions/{questionId} {
      allow get, list: if true;
      allow create: if request.auth.uid != null;
      allow update: if request.auth.uid != null;
      allow delete: if request.auth.uid != null;
    }

    /**
     * @description Defines read/write access for exams. Read is public.
     * @path /exams/{examId}
     * @allow (get, list) Any user can read exam information.
     * @deny (create, update, delete) Only authenticated users can create, update, or delete exams.
     * @principle Public read access with owner-only writes (requires ownership field in document).
     */
    match /exams/{examId} {
      allow get, list: if true;
      allow create: if request.auth.uid != null;
      allow update: if request.auth.uid != null;
      allow delete: if request.auth.uid != null;
    }

    /**
     * @description Defines read/write access for attempts. Read is public.
     * @path /attempts/{attemptId}
     * @allow (get, list) Any user can read attempt information.
     * @deny (create, update, delete) Only authenticated users can create, update, or delete attempts.
     * @principle Public read access with owner-only writes (requires ownership field in document).
     */
    match /attempts/{attemptId} {
      allow get, list: if true;
      allow create: if request.auth.uid != null;
      allow update: if request.auth.uid != null;
      allow delete: if request.auth.uid != null;
    }

    /**
     * @description Defines read/write access for daily metrics. Read is public.
     * @path /metrics/daily/{date}
     * @allow (get, list) Any user can read daily metrics.
     * @deny (create, update, delete) Only authenticated users can create, update, or delete daily metrics.
     * @principle Public read access with owner-only writes (requires ownership field in document).
     */
    match /metrics/daily/{date} {
      allow get, list: if true;
      allow create: if request.auth.uid != null;
      allow update: if request.auth.uid != null;
      allow delete: if request.auth.uid != null;
    }

    /**
     * @description Defines read/write access for course competencies. Read is public.
     * @path /courseCompetencies/{courseCompetencyId}
     * @allow (get, list) Any user can read course competency information.
     * @deny (create, update, delete) Only authenticated users can create, update, or delete course competencies.
     * @principle Public read access with owner-only writes (requires ownership field in document).
     */
    match /courseCompetencies/{courseCompetencyId} {
      allow get, list: if true;
      allow create: if request.auth.uid != null;
      allow update: if request.auth.uid != null;
      allow delete: if request.auth.uid != null;
    }

    /**
     * @description Protects user achievements, ensuring only the authenticated user can read or write their own data.
     * @path /users/{userId}/achievements/{userAchievementId}
     * @allow (create) User with ID matching auth UID can create their profile.
     * @allow (get, list, update, delete) Authenticated user can only access their own profile.
     * @deny (create) User attempts to create a profile with a mismatched ID.
     * @deny (update, delete) User attempts to modify or delete another user's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/achievements/{userAchievementId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Defines read/write access for master courses. Read is public.
     * @path /masterCourses/{masterCourseId}
     * @allow (get, list) Any user can read master course information.
     * @deny (create, update, delete) Only authenticated users can create, update, or delete master courses.
     * @principle Public read access with owner-only writes (requires ownership field in document).
     */
    match /masterCourses/{masterCourseId} {
      allow get, list: if true;
      allow create: if request.auth.uid != null;
      allow update: if request.auth.uid != null;
      allow delete: if request.auth.uid != null;
    }

    /**
     * @description Defines read/write access for master certificates. Read is public.
     * @path /masterCertificates/{masterCertificateId}
     * @allow (get, list) Any user can read master certificate information.
     * @deny (create, update, delete) Only authenticated users can create, update, or delete master certificates.
     * @principle Public read access with owner-only writes (requires ownership field in document).
     */
    match /masterCertificates/{masterCertificateId} {
      allow get, list: if true;
      allow create: if request.auth.uid != null;
      allow update: if request.auth.uid != null;
      allow delete: if request.auth.uid != null;
    }

    /**
     * @description Defines read/write access for roadmaps. Read is public.
     * @path /roadmaps/{roadmapId}
     * @allow (get, list) Any user can read roadmap information.
     * @deny (create, update, delete) Only authenticated users can create, update, or delete roadmaps.
     * @principle Public read access with owner-only writes (requires ownership field in document).
     */
    match /roadmaps/{roadmapId} {
      allow get, list: if true;
      allow create: if request.auth.uid != null;
      allow update: if request.auth.uid != null;
      allow delete: if request.auth.uid != null;
    }

    /**
     * @description Defines read/write access for schedules. Read is public.
     * @path /schedules/{scheduleId}
     * @allow (get, list) Any user can read schedule information.
     * @deny (create, update, delete) Only authenticated users can create, update, or delete schedules.
     * @principle Public read access with owner-only writes (requires ownership field in document).
     */
    match /schedules/{scheduleId} {
      allow get, list: if true;
      allow create: if request.auth.uid != null;
      allow update: if request.auth.uid != null;
      allow delete: if request.auth.uid != null;
    }

    /**
     * @description Defines read/write access for quizzes. Read is public.
     * @path /quizzes/{quizId}
     * @allow (get, list) Any user can read quiz information.
     * @deny (create, update, delete) Only authenticated users can create, update, or delete quizzes.
     * @principle Public read access with owner-only writes (requires ownership field in document).
     */
    match /quizzes/{quizId} {
      allow get, list: if true;
      allow create: if request.auth.uid != null;
      allow update: if request.auth.uid != null;
      allow delete: if request.auth.uid != null;
    }
  }
}