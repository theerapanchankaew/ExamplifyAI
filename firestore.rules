/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user profiles and achievements.
 *  It allows public read access to course-related data while restricting writes to authenticated users.
 *  Administrative access or data validation is not supported by these rules.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles, where {userId} must match the authenticated user's UID.
 * - /users/{userId}/achievements/{achievementId}: Stores achievements for a specific user, accessible only to that user.
 * - /courses/{courseId}: Stores course information, publicly readable.
 * - /lessons/{lessonId}: Stores lesson information, publicly readable.
 * - /questions/{questionId}: Stores questions, publicly readable.
 * - /exams/{examId}: Stores exam information, publicly readable.
 * - /attempts/{attemptId}: Stores exam attempts, publicly readable.
 * - /metrics/daily/{date}: Stores daily metrics, publicly readable.
 * - /courseCompetencies/{courseCompetencyId}: Stores course competencies, publicly readable.
 * - /masterCourses/{masterCourseId}: Stores master courses, publicly readable.
 * - /masterCertificates/{masterCertificateId}: Stores master certificates, publicly readable.
 * - /roadmaps/{roadmapId}: Stores roadmaps, publicly readable.
 * - /schedules/{scheduleId}: Stores schedules, publicly readable.
 * - /quizzes/{quizId}: Stores quizzes, publicly readable.
 *
 * Key Security Decisions:
 * - User listing is explicitly disallowed.
 * - Public read access is granted to course, lesson, question, exam, attempt, metric, courseCompetency, masterCourse, masterCertificate, roadmap, schedule and quiz data.
 * - All write operations require user authentication.
 * - No data validation is performed beyond ownership checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to user profiles based on ownership.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their profile if userId matches their auth UID.
     * @allow (get, list) - Authenticated user can read their profile if userId matches their auth UID.
     * @allow (update, delete) - Authenticated user can update/delete their profile if userId matches their auth UID and the document exists.
     * @deny (create) - If the `userId` does not match the authenticated user's UID.
     * @deny (update, delete) - If the document doesn't exist.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants access to user achievements based on ownership.
     * @path /users/{userId}/achievements/{userAchievementId}
     * @allow (create) - Authenticated user can create their achievement if userId matches their auth UID.
     * @allow (get, list) - Authenticated user can read their achievement if userId matches their auth UID.
     * @allow (update, delete) - Authenticated user can update/delete their achievement if userId matches their auth UID and the document exists.
     * @deny (create) - If the `userId` does not match the authenticated user's UID.
     * @deny (update, delete) - If the document doesn't exist.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/achievements/{userAchievementId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Grants public read access to courses.
     * @path /courses/{courseId}
     * @allow (get, list) - Anyone can read course data.
     * @allow (create, update, delete) - Only signed in users can write.
     * @deny (create, update, delete) - If the user is not signed in.
     * @principle Allows public read access.
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

     /**
      * @description Grants public read access to lessons.
      * @path /lessons/{lessonId}
      * @allow (get, list) - Anyone can read lesson data.
      * @allow (create, update, delete) - Only signed in users can write.
      * @deny (create, update, delete) - If the user is not signed in.
      * @principle Allows public read access.
      */
    match /lessons/{lessonId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Grants public read access to questions.
     * @path /questions/{questionId}
     * @allow (get, list) - Anyone can read question data.
     * @allow (create, update, delete) - Only signed in users can write.
     * @deny (create, update, delete) - If the user is not signed in.
     * @principle Allows public read access.
     */
    match /questions/{questionId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Grants public read access to exams.
     * @path /exams/{examId}
     * @allow (get, list) - Anyone can read exam data.
     * @allow (create, update, delete) - Only signed in users can write.
     * @deny (create, update, delete) - If the user is not signed in.
     * @principle Allows public read access.
     */
    match /exams/{examId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Grants public read access to attempts.
     * @path /attempts/{attemptId}
     * @allow (get, list) - Anyone can read attempts data.
     * @allow (create, update, delete) - Only signed in users can write.
     * @deny (create, update, delete) - If the user is not signed in.
     * @principle Allows public read access.
     */
    match /attempts/{attemptId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Grants public read access to daily metrics.
     * @path /metrics/daily/{date}
     * @allow (get, list) - Anyone can read daily metrics data.
     * @allow (create, update, delete) - Only signed in users can write.
     * @deny (create, update, delete) - If the user is not signed in.
     * @principle Allows public read access.
     */
    match /metrics/daily/{date} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Grants public read access to course competencies.
     * @path /courseCompetencies/{courseCompetencyId}
     * @allow (get, list) - Anyone can read course competencies data.
     * @allow (create, update, delete) - Only signed in users can write.
     * @deny (create, update, delete) - If the user is not signed in.
     * @principle Allows public read access.
     */
    match /courseCompetencies/{courseCompetencyId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Grants public read access to master courses.
     * @path /masterCourses/{masterCourseId}
     * @allow (get, list) - Anyone can read master courses data.
     * @allow (create, update, delete) - Only signed in users can write.
     * @deny (create, update, delete) - If the user is not signed in.
     * @principle Allows public read access.
     */
    match /masterCourses/{masterCourseId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Grants public read access to master certificates.
     * @path /masterCertificates/{masterCertificateId}
     * @allow (get, list) - Anyone can read master certificates data.
     * @allow (create, update, delete) - Only signed in users can write.
     * @deny (create, update, delete) - If the user is not signed in.
     * @principle Allows public read access.
     */
    match /masterCertificates/{masterCertificateId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Grants public read access to roadmaps.
     * @path /roadmaps/{roadmapId}
     * @allow (get, list) - Anyone can read roadmaps data.
     * @allow (create, update, delete) - Only signed in users can write.
     * @deny (create, update, delete) - If the user is not signed in.
     * @principle Allows public read access.
     */
    match /roadmaps/{roadmapId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Grants public read access to schedules.
     * @path /schedules/{scheduleId}
     * @allow (get, list) - Anyone can read schedules data.
     * @allow (create, update, delete) - Only signed in users can write.
     * @deny (create, update, delete) - If the user is not signed in.
     * @principle Allows public read access.
     */
    match /schedules/{scheduleId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Grants public read access to quizzes.
     * @path /quizzes/{quizId}
     * @allow (get, list) - Anyone can read quizzes data.
     * @allow (create, update, delete) - Only signed in users can write.
     * @deny (create, update, delete) - If the user is not signed in.
     * @principle Allows public read access.
     */
    match /quizzes/{quizId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }
  }
}