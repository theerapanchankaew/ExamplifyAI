/**
 * @fileoverview Firestore Security Rules for ExamplifyAI.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and achievements.
 * Exam attempts are accessible to the owner. Other data is generally public read, but protected on write.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, `userId` must match `auth.uid`.
 * - /users/{userId}/achievements/{achievementId}: User-specific achievements.
 * - /courses/{courseId}: Public course information.
 * - /lessons/{lessonId}: Public lesson information.
 * - /questions/{questionId}: Public question bank.
 * - /exams/{examId}: Public exam definitions.
 * - /attempts/{attemptId}: User exam attempts, `userId` in the document must match `auth.uid`.
 * - /metrics/daily/{date}: Daily metrics.
 * - /courseCompetencies/{courseCompetencyId}: Course to competency mappings.
 * - /masterCourses/{masterCourseId}: Master course definitions.
 * - /masterCertificates/{masterCertificateId}: Master certificates.
 * - /roadmaps/{roadmapId}: Roadmap definitions.
 * - /schedules/{scheduleId}: Schedule events.
 * - /quizzes/{quizId}: Quiz information.
 *
 * Key Security Decisions:
 * - Users can only read/write their own profile and achievements.
 * - Attempts are readable and listable by the user who created them.
 * - Public data (courses, lessons, questions, exams, etc.) is readable by all, but write access is restricted.  (TODO: Implement role-based access for writes)
 * - Listing of attempts is allowed to authenticated users.
 *
 * Denormalization for Authorization:
 * - Attempts documents must contain a `userId` field that matches the user's UID to avoid needing a separate lookup.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @path N/A (Helper Function)
     * @allow N/A (Helper Function)
     * @deny N/A (Helper Function)
     * @principle Authentication
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the resource.
     * @path N/A (Helper Function)
     * @allow N/A (Helper Function)
     * @deny N/A (Helper Function)
     * @principle Ownership
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of the existing resource.
     * @path N/A (Helper Function)
     * @allow N/A (Helper Function)
     * @deny N/A (Helper Function)
     * @principle Ownership and Existence
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces user-ownership for user profiles.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' creates their own profile at /users/user123.
     * @allow (get) User with UID 'user123' reads their own profile at /users/user123.
     * @allow (update) User with UID 'user123' updates their own profile at /users/user123.
     * @allow (delete) User with UID 'user123' deletes their own profile at /users/user123.
     * @deny (create) User with UID 'user123' attempts to create a profile for 'user456' at /users/user456.
     * @deny (get) User with UID 'user123' attempts to read profile of 'user456' at /users/user456.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to course information.
     * @path /courses/{courseId}
     * @allow (get) Any user can read a course at /courses/course123.
     * @allow (list) Any user can list courses.
     * @deny (create) Any user cannot create a course.
     * @principle Public read access with restricted write access.
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based write access
      allow update: if false; // TODO: Add role-based write access
      allow delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Allows public read access to lesson information.
     * @path /lessons/{lessonId}
     * @allow (get) Any user can read a lesson at /lessons/lesson123.
     * @allow (list) Any user can list lessons.
     * @deny (create) Any user cannot create a lesson.
     * @principle Public read access with restricted write access.
     */
    match /lessons/{lessonId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based write access
      allow update: if false; // TODO: Add role-based write access
      allow delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Allows public read access to question information.
     * @path /questions/{questionId}
     * @allow (get) Any user can read a question at /questions/question123.
     * @allow (list) Any user can list questions.
     * @deny (create) Any user cannot create a question.
     * @principle Public read access with restricted write access.
     */
    match /questions/{questionId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based write access
      allow update: if false; // TODO: Add role-based write access
      allow delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Allows public read access to exam information.
     * @path /exams/{examId}
     * @allow (get) Any user can read an exam at /exams/exam123.
     * @allow (list) Any user can list exams.
     * @deny (create) Any user cannot create an exam.
     * @principle Public read access with restricted write access.
     */
    match /exams/{examId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based write access
      allow update: if false; // TODO: Add role-based write access
      allow delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Allows a user to read, create, update, and delete their own attempt.
     * @path /attempts/{attemptId}
     * @allow (create) User with UID 'user123' creates an attempt with userId 'user123'.
     * @allow (get) User with UID 'user123' reads their own attempt where attempt.userId == 'user123'.
     * @allow (update) User with UID 'user123' updates their own attempt where attempt.userId == 'user123'.
     * @allow (delete) User with UID 'user123' deletes their own attempt where attempt.userId == 'user123'.
     * @deny (create) User with UID 'user123' creates an attempt with userId 'user456'.
     * @deny (get) User with UID 'user123' reads an attempt where attempt.userId == 'user456'.
     * @principle Enforces user-ownership for attempts.
     */
    match /attempts/{attemptId} {
      allow get: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isSignedIn() && isExistingOwner(resource.data.userId);
    }

    /**
     * @description Allows public read access to daily metrics.
     * @path /metrics/daily/{date}
     * @allow (get) Any user can read daily metrics for a specific date.
     * @allow (list) Any user can list daily metrics.
     * @deny (create) Any user cannot create daily metrics.
     * @principle Public read access with restricted write access.
     */
    match /metrics/daily/{date} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based write access
      allow update: if false; // TODO: Add role-based write access
      allow delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Allows public read access to course competencies.
     * @path /courseCompetencies/{courseCompetencyId}
     * @allow (get) Any user can read a course competency.
     * @allow (list) Any user can list course competencies.
     * @deny (create) Any user cannot create a course competency.
     * @principle Public read access with restricted write access.
     */
    match /courseCompetencies/{courseCompetencyId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based write access
      allow update: if false; // TODO: Add role-based write access
      allow delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Enforces user-ownership for user achievements.
     * @path /users/{userId}/achievements/{userAchievementId}
     * @allow (create) User with UID 'user123' creates an achievement at /users/user123/achievements/achievement1.
     * @allow (get) User with UID 'user123' reads their own achievement at /users/user123/achievements/achievement1.
     * @allow (update) User with UID 'user123' updates their own achievement at /users/user123/achievements/achievement1.
     * @allow (delete) User with UID 'user123' deletes their own achievement at /users/user123/achievements/achievement1.
     * @deny (create) User with UID 'user123' attempts to create an achievement for 'user456'.
     * @deny (get) User with UID 'user123' attempts to read achievement of 'user456'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/achievements/{userAchievementId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to master courses.
     * @path /masterCourses/{masterCourseId}
     * @allow (get) Any user can read a master course.
     * @allow (list) Any user can list master courses.
     * @deny (create) Any user cannot create a master course.
     * @principle Public read access with restricted write access.
     */
    match /masterCourses/{masterCourseId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based write access
      allow update: if false; // TODO: Add role-based write access
      allow delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Allows public read access to master certificates.
     * @path /masterCertificates/{masterCertificateId}
     * @allow (get) Any user can read a master certificate.
     * @allow (list) Any user can list master certificates.
     * @deny (create) Any user cannot create a master certificate.
     * @principle Public read access with restricted write access.
     */
    match /masterCertificates/{masterCertificateId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based write access
      allow update: if false; // TODO: Add role-based write access
      allow delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Allows public read access to roadmaps.
     * @path /roadmaps/{roadmapId}
     * @allow (get) Any user can read a roadmap.
     * @allow (list) Any user can list roadmaps.
     * @deny (create) Any user cannot create a roadmap.
     * @principle Public read access with restricted write access.
     */
    match /roadmaps/{roadmapId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based write access
      allow update: if false; // TODO: Add role-based write access
      allow delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Allows public read access to schedules.
     * @path /schedules/{scheduleId}
     * @allow (get) Any user can read a schedule.
     * @allow (list) Any user can list schedules.
     * @deny (create) Any user cannot create a schedule.
     * @principle Public read access with restricted write access.
     */
    match /schedules/{scheduleId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based write access
      allow update: if false; // TODO: Add role-based write access
      allow delete: if false; // TODO: Add role-based write access
    }

    /**
     * @description Allows public read access to quizzes.
     * @path /quizzes/{quizId}
     * @allow (get) Any user can read a quiz.
     * @allow (list) Any user can list quizzes.
     * @deny (create) Any user cannot create a quiz.
     * @principle Public read access with restricted write access.
     */
    match /quizzes/{quizId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based write access
      allow update: if false; // TODO: Add role-based write access
      allow delete: if false; // TODO: Add role-based write access
    }
  }
}