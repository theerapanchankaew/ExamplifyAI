/**
 * @fileoverview Firestore Security Rules for ExamplifyAI.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles and achievements.
 * Public read access is allowed for general content like courses, lessons, exams, and questions.
 * Writes are generally restricted to prevent unauthorized data modification.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, secured with owner-only access.
 * - /courses/{courseId}: Stores course information, publicly readable.
 * - /lessons/{lessonId}: Stores lesson information, publicly readable.
 * - /questions/{questionId}: Stores question information, publicly readable.
 * - /exams/{examId}: Stores exam information, publicly readable.
 * - /attempts/{attemptId}: Stores user exam attempts, publicly readable
 * - /metrics/daily/{date}: Stores daily metrics, publicly readable.
 * - /courseCompetencies/{courseCompetencyId}: Stores course competencies, publicly readable.
 * - /users/{userId}/achievements/{userAchievementId}: Stores user achievements, secured with owner-only access.
 * - /masterCourses/{masterCourseId}: Stores master course information, publicly readable.
 * - /masterCertificates/{masterCertificateId}: Stores master certificates, publicly readable.
 * - /roadmaps/{roadmapId}: Stores roadmaps, publicly readable.
 * - /schedules/{scheduleId}: Stores schedules, publicly readable.
 * - /quizzes/{quizId}: Stores quizzes, publicly readable.
 *
 * Key Security Decisions:
 * - User listing is disallowed for privacy.
 * - Default security posture is to deny access unless explicitly allowed.
 * - Public read access is granted to most non-user-specific collections.
 *
 * Denormalization for Authorization:
 *  - The rules assume that each document that belongs to a user (e.g., attempts, achievements)
 *    has a `userId` field that matches the user's UID. This avoids the need for complex queries
 *    or `get()` calls in the rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the resource.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Defines a global helper function to check if the user is an admin.
     * @note This is a placeholder and should be replaced with a more robust role-based access control system.
     */
    function isAdmin() {
        return request.auth.token.email == 'admin@masci.com';
    }


    /**
     * @description Rules for user profiles. Only the authenticated user can read/write their own profile.
     * @path /users/{userId}
     * @allow (create) User with userId 'OOjU7LTqSRWfjF8sMOOq4geYjYy2' creates profile with matching userId.
     * @allow (get) User with userId 'OOjU7LTqSRWfjF8sMOOq4geYjYy2' reads their own profile.
     * @allow (update) User with userId 'OOjU7LTqSRWfjF8sMOOq4geYjYy2' updates their own profile.
     * @allow (delete) User with userId 'OOjU7LTqSRWfjF8sMOOq4geYjYy2' deletes their own profile.
     * @deny (create) User with userId 'OTHER_USER_ID' attempts to create a profile with userId 'OOjU7LTqSRWfjF8sMOOq4geYjYy2'.
     * @deny (get) User with userId 'OTHER_USER_ID' attempts to read profile with userId 'OOjU7LTqSRWfjF8sMOOq4geYjYy2'.
     * @deny (update) User with userId 'OTHER_USER_ID' attempts to update profile with userId 'OOjU7LTqSRWfjF8sMOOq4geYjYy2'.
     * @deny (delete) User with userId 'OTHER_USER_ID' attempts to delete profile with userId 'OOjU7LTqSRWfjF8sMOOq4geYjYy2'.
     * @principle Enforces document ownership for writes.  Restricts access to a user's own data tree.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // User listing is not allowed.
      allow create: if isOwner(userId) && request.resource.data.get('userId', '') == userId;
      allow update: if isOwner(userId) && request.resource.data.get('userId', '') == userId;
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for courses.  Anyone can read course information.
     * @path /courses/{courseId}
     * @allow (get) Any user can read course data.
     * @allow (list) Any user can list courses.
     * @deny (create) Only admins can create courses.  // TODO: Add admin role check when roles are implemented.
     * @deny (update) Only admins can update courses. // TODO: Add admin role check when roles are implemented.
     * @deny (delete) Only admins can delete courses. // TODO: Add admin role check when roles are implemented.
     * @principle Public read, restricted write access.
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for lessons. Anyone can read lesson information.
     * @path /lessons/{lessonId}
     * @allow (get) Any user can read lesson data.
     * @allow (list) Any user can list lessons.
     * @deny (create) Only admins can create lessons.  // TODO: Add admin role check when roles are implemented.
     * @deny (update) Only admins can update lessons. // TODO: Add admin role check when roles are implemented.
     * @deny (delete) Only admins can delete lessons. // TODO: Add admin role check when roles are implemented.
     * @principle Public read, restricted write access.
     */
    match /lessons/{lessonId} {
      allow get, list: if true;
      allow create: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for questions. Anyone can read question information.
     * @path /questions/{questionId}
     * @allow (get) Any user can read question data.
     * @allow (list) Any user can list questions.
     * @deny (create) Only admins can create questions.  // TODO: Add admin role check when roles are implemented.
     * @deny (update) Only admins can update questions. // TODO: Add admin role check when roles are implemented.
     * @deny (delete) Only admins can delete questions. // TODO: Add admin role check when roles are implemented.
     * @principle Public read, restricted write access.
     */
    match /questions/{questionId} {
      allow get, list: if true;
      allow create: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for exams. Anyone can read exam information.
     * @path /exams/{examId}
     * @allow (get) Any user can read exam data.
     * @allow (list) Any user can list exams.
     * @deny (create) Only admins can create exams.  // TODO: Add admin role check when roles are implemented.
     * @deny (update) Only admins can update exams. // TODO: Add admin role check when roles are implemented.
     * @deny (delete) Only admins can delete exams. // TODO: Add admin role check when roles are implemented.
     * @principle Public read, restricted write access.
     */
    match /exams/{examId} {
      allow get, list: if true;
      allow create: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for attempts. Anyone can read attempts information.
     * @path /attempts/{attemptId}
     * @allow (get) Any user can read attempt data.
     * @allow (list) Any user can list attempts.
     * @deny (create) Only admins can create attempts.  // TODO: Add admin role check when roles are implemented.
     * @deny (update) Only admins can update attempts. // TODO: Add admin role check when roles are implemented.
     * @deny (delete) Only admins can delete attempts. // TODO: Add admin role check when roles are implemented.
     * @principle Public read, restricted write access.
     */
    match /attempts/{attemptId} {
      allow get, list: if true;
      allow create: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for daily metrics. Anyone can read daily metrics.
     * @path /metrics/daily/{date}
     * @allow (get) Any user can read daily metrics data.
     * @allow (list) Any user can list daily metrics.
     * @deny (create) Only admins can create daily metrics.  // TODO: Add admin role check when roles are implemented.
     * @deny (update) Only admins can update daily metrics. // TODO: Add admin role check when roles are implemented.
     * @deny (delete) Only admins can delete daily metrics. // TODO: Add admin role check when roles are implemented.
     * @principle Public read, restricted write access.
     */
    match /metrics/daily/{date} {
      allow get, list: if true;
      allow create: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for course competencies. Anyone can read course competencies information.
     * @path /courseCompetencies/{courseCompetencyId}
     * @allow (get) Any user can read course competencies data.
     * @allow (list) Any user can list course competencies.
     * @deny (create) Only admins can create course competencies.  // TODO: Add admin role check when roles are implemented.
     * @deny (update) Only admins can update course competencies. // TODO: Add admin role check when roles are implemented.
     * @deny (delete) Only admins can delete course competencies. // TODO: Add admin role check when roles are implemented.
     * @principle Public read, restricted write access.
     */
    match /courseCompetencies/{courseCompetencyId} {
      allow get, list: if true;
      allow create: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for user achievements. Only the authenticated user can read/write their own achievements.
     * @path /users/{userId}/achievements/{userAchievementId}
     * @allow (create) User with userId 'OOjU7LTqSRWfjF8sMOOq4geYjYy2' creates achievement with matching userId.
     * @allow (get) User with userId 'OOjU7LTqSRWfjF8sMOOq4geYjYy2' reads their own achievement.
     * @allow (update) User with userId 'OOjU7LTqSRWfjF8sMOOq4geYjYy2' updates their own achievement.
     * @allow (delete) User with userId 'OOjU7LTqSRWfjF8sMOOq4geYjYy2' deletes their own achievement.
     * @deny (create) User with userId 'OTHER_USER_ID' attempts to create an achievement with userId 'OOjU7LTqSRWfjF8sMOOq4geYjYy2'.
     * @deny (get) User with userId 'OTHER_USER_ID' attempts to read achievement with userId 'OOjU7LTqSRWfjF8sMOOq4geYjYy2'.
     * @deny (update) User with userId 'OTHER_USER_ID' attempts to update achievement with userId 'OOjU7LTqSRWfjF8sMOOq4geYjYy2'.
     * @deny (delete) User with userId 'OTHER_USER_ID' attempts to delete achievement with userId 'OOjU7LTqSRWfjF8sMOOq4geYjYy2'.
     * @principle Enforces document ownership for writes. Restricts access to a user's own data tree.
     */
    match /users/{userId}/achievements/{userAchievementId} {
      allow get: if isOwner(userId);
      allow list: if false; // Listing achievements should not be generally allowed.
      allow create: if isOwner(userId) && request.resource.data.get('userId', '') == userId;
      allow update: if isOwner(userId) && request.resource.data.get('userId', '') == userId;
      allow delete: if isOwner(userId) && resource.data.get('userId', '') == userId;
    }

    /**
     * @description Rules for master courses. Anyone can read master course information.
     * @path /masterCourses/{masterCourseId}
     * @allow (get) Any user can read master course data.
     * @allow (list) Any user can list master courses.
     * @deny (create) Only admins can create master courses.  // TODO: Add admin role check when roles are implemented.
     * @deny (update) Only admins can update master courses. // TODO: Add admin role check when roles are implemented.
     * @deny (delete) Only admins can delete master courses. // TODO: Add admin role check when roles are implemented.
     * @principle Public read, restricted write access.
     */
    match /masterCourses/{masterCourseId} {
      allow get, list: if true;
      allow create: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for master certificates. Anyone can read master certificate information.
     * @path /masterCertificates/{masterCertificateId}
     * @allow (get) Any user can read master certificate data.
     * @allow (list) Any user can list master certificates.
     * @deny (create) Only admins can create master certificates.  // TODO: Add admin role check when roles are implemented.
     * @deny (update) Only admins can update master certificates. // TODO: Add admin role check when roles are implemented.
     * @deny (delete) Only admins can delete master certificates. // TODO: Add admin role check when roles are implemented.
     * @principle Public read, restricted write access.
     */
    match /masterCertificates/{masterCertificateId} {
      allow get, list: if true;
      allow create: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for roadmaps. Anyone can read roadmap information.
     * @path /roadmaps/{roadmapId}
     * @allow (get) Any user can read roadmap data.
     * @allow (list) Any user can list roadmaps.
     * @deny (create) Only admins can create roadmaps.  // TODO: Add admin role check when roles are implemented.
     * @deny (update) Only admins can update roadmaps. // TODO: Add admin role check when roles are implemented.
     * @deny (delete) Only admins can delete roadmaps. // TODO: Add admin role check when roles are implemented.
     * @principle Public read, restricted write access.
     */
    match /roadmaps/{roadmapId} {
      allow get, list: if true;
      allow create: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for schedules. Anyone can read schedule information.
     * @path /schedules/{scheduleId}
     * @allow (get) Any user can read schedule data.
     * @allow (list) Any user can list schedules.
     * @deny (create) Only admins can create schedules.  // TODO: Add admin role check when roles are implemented.
     * @deny (update) Only admins can update schedules. // TODO: Add admin role check when roles are implemented.
     * @deny (delete) Only admins can delete schedules. // TODO: Add admin role check when roles are implemented.
     * @principle Public read, restricted write access.
     */
    match /schedules/{scheduleId} {
      allow get, list: if true;
      allow create: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }

     /**
     * @description Rules for quizzes. Anyone can read quiz information.
     * @path /quizzes/{quizId}
     * @allow (get) Any user can read quiz data.
     * @allow (list) Any user can list quizzes.
     * @deny (create) Only admins can create quizzes.  // TODO: Add admin role check when roles are implemented.
     * @deny (update) Only admins can update quizzes. // TODO: Add admin role check when roles are implemented.
     * @deny (delete) Only admins can delete quizzes. // TODO: Add admin role check when roles are implemented.
     * @principle Public read, restricted write access.
     */
    match /quizzes/{quizId} {
      allow get, list: if true;
      allow create: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if isAdmin(); // TODO: Add owner validation once the schema is updated with an ownership field.
    }
  }
}