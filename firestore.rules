/**
 * @fileoverview Firestore Security Rules for ExamplifyAI.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and achievements,
 * and public read access for courses, lessons, questions, exams, roadmaps, master courses, schedules, and quizzes.
 * Exam attempts and master certificates are also user-owned. System metrics are write-protected.
 *
 * Data Structure:
 * - `/users/{userId}`: User profiles, accessible only by the owner.
 * - `/courses/{courseId}`: Publicly readable course information.
 * - `/lessons/{lessonId}`: Publicly readable lesson information.
 * - `/questions/{questionId}`: Publicly readable question bank.
 * - `/exams/{examId}`: Publicly readable exam definitions.
 * - `/attempts/{attemptId}`: User-specific exam attempts, accessible only by the owner.
 * - `/metrics/daily/{date}`: Daily system metrics, write-protected.
 * - `/courseCompetencies/{courseCompetencyId}`: Publicly readable course competency mappings.
 * - `/users/{userId}/achievements/{userAchievementId}`: User achievements, accessible only by the owner.
 * - `/masterCourses/{masterCourseId}`: Publicly readable master course definitions.
 * - `/masterCertificates/{masterCertificateId}`: User-specific master certificates, accessible only by the owner.
 * - `/roadmaps/{roadmapId}`: Publicly readable roadmap definitions.
 * - `/schedules/{scheduleId}`: Publicly readable schedule events.
 * - `/quizzes/{quizId}`: Publicly readable quiz information.
 *
 * Key Security Decisions:
 * - User data is strictly controlled by the user's ID.
 * - Public collections are readable by everyone but writable only according to the rules defined for each collection.
 * - Daily metrics are only meant to be written by backend services, so we explicitly deny all client writes.
 *
 * Denormalization for Authorization:
 *  - User achievements are stored as subcollections under the user's document to simplify ownership checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user profile access. Only the authenticated user can read/write their own profile.
     * @path /users/{userId}
     * @allow (create, update, delete) if request.auth.uid == userId
     * @allow (get, list) if request.auth.uid == userId
     * @deny (create, update, delete) if request.auth.uid != userId
     * @deny (get, list) if request.auth.uid != userId
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isOwner(userId) && resource != null;

      /**
       * @description Manages user achievement access. Only the authenticated user can read/write their own achievements.
       * @path /users/{userId}/achievements/{userAchievementId}
       * @allow (create, update, delete) if request.auth.uid == userId
       * @allow (get, list) if request.auth.uid == userId
       * @deny (create, update, delete) if request.auth.uid != userId
       * @deny (get, list) if request.auth.uid != userId
       * @principle Enforces document ownership for writes.
       */
      match /achievements/{userAchievementId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId) && resource != null;
        allow delete: if isOwner(userId) && resource != null;
      }
    }

    /**
     * @description Allows public read access to course information.
     * @path /courses/{courseId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access and prohibits write access.
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to lesson information.
     * @path /lessons/{lessonId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access and prohibits write access.
     */
    match /lessons/{lessonId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to questions.
     * @path /questions/{questionId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access and prohibits write access.
     */
    match /questions/{questionId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to exams.
     * @path /exams/{examId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access and prohibits write access.
     */
    match /exams/{examId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to user exam attempts. Only the authenticated user can read/write their own attempts.
     * @path /attempts/{attemptId}
     * @allow (create, update, delete) if request.auth.uid == resource.data.userId
     * @allow (get, list) if request.auth.uid == resource.data.userId
     * @deny (create, update, delete) if request.auth.uid != resource.data.userId
     * @deny (get, list) if request.auth.uid != resource.data.userId
     * @principle Enforces document ownership for writes.
     */
    match /attempts/{attemptId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get, list: if isOwner(resource.data.userId);
      allow create: if isOwner(request.auth.uid) && request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId) && request.resource.data.userId == resource.data.userId && resource != null;
      allow delete: if isOwner(resource.data.userId) && resource != null;
    }

    /**
     * @description Restricts access to daily metrics. No client-side writes are allowed.
     * @path /metrics/daily/{date}
     * @deny (get, list, create, update, delete) if true
     * @principle Denies all client-side access to metrics.
     */
    match /metrics/daily/{date} {
      allow get, list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to course competencies.
     * @path /courseCompetencies/{courseCompetencyId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access and prohibits write access.
     */
    match /courseCompetencies/{courseCompetencyId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to master courses.
     * @path /masterCourses/{masterCourseId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access and prohibits write access.
     */
    match /masterCourses/{masterCourseId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to master certificates. Only the authenticated user can read/write their own certificates.
     * @path /masterCertificates/{masterCertificateId}
     * @allow (create, update, delete) if request.auth.uid == resource.data.userId
     * @allow (get, list) if request.auth.uid == resource.data.userId
     * @deny (create, update, delete) if request.auth.uid != resource.data.userId
     * @deny (get, list) if request.auth.uid != resource.data.userId
     * @principle Enforces document ownership for writes.
     */
    match /masterCertificates/{masterCertificateId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get, list: if isOwner(resource.data.userId);
      allow create: if isOwner(request.auth.uid) && request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId) && request.resource.data.userId == resource.data.userId && resource != null;
      allow delete: if isOwner(resource.data.userId) && resource != null;
    }

    /**
     * @description Allows public read access to roadmaps.
     * @path /roadmaps/{roadmapId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access and prohibits write access.
     */
    match /roadmaps/{roadmapId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to schedules.
     * @path /schedules/{scheduleId}
     * @allow (get, list) if true
     * @deny (create, update, delete) if true
     * @principle Allows public read access and prohibits write access.
     */
    match /schedules/{scheduleId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

     /**
      * @description Allows public read access to quizzes.
      * @path /quizzes/{quizId}
      * @allow (get, list) if true
      * @deny (create, update, delete) if true
      * @principle Allows public read access and prohibits write access.
      */
    match /quizzes/{quizId} {
        allow get, list: if true;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }
  }
}