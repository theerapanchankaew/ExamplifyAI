/**
 * @fileoverview Firestore Security Rules for ExamplifyAI.
 *
 * Core Philosophy:
 * This ruleset employs a hybrid security model, balancing open access for public content with strict user-ownership and role-based access for sensitive data.
 *
 * Data Structure:
 * - User-specific data (profiles, achievements) is nested under `/users/{userId}`.
 * - Course and learning content (courses, lessons, questions, exams, quizzes) are stored in top-level collections.
 * - Attempts are stored in `/attempts/{attemptId}`.
 * - MasterCourses, MasterCertificates, Roadmaps, and Schedules are stored in top-level collections.
 *
 * Key Security Decisions:
 * - Users can only read/write their own profiles and achievements.
 * - Listing of user documents is disallowed for privacy.
 * - Public read access is granted for course content.
 * - Writes to course content are not explicitly restricted in this prototype but SHOULD be restricted to authorized users (e.g., instructors, admins) in a production environment via role-based checks.
 * - Attempts should be readable by the user who created them.
 *
 * Denormalization for Authorization:
 * To avoid costly `get()` operations, consider denormalizing authorization data (e.g., course instructor roles) directly into course documents if fine-grained access control is required.
 *
 * Structural Segregation:
 * No explicit segregation used.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the resource.
     * @param {string} userId The user ID to check against.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the existing owner of the resource.
     * @param {string} userId The user ID to check against.
     * @return {boolean} True if the user is the existing owner, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) User with UID 'user_abc' can create their profile if request.auth.uid == 'user_abc'.
     * @deny (create) User with UID 'user_abc' cannot create a profile for 'user_xyz'.
     * @allow (get) User with UID 'user_abc' can read their profile at /users/user_abc.
     * @deny (get) User with UID 'user_abc' cannot read the profile of /users/user_xyz.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for courses.
     * @path /courses/{courseId}
     * @allow (get) Any user can read course data.
     * @allow (list) Any user can list courses.
     * @deny (create) No users can create courses (explicit for prototyping).
     * @principle Allows public read access; writes SHOULD be restricted to authorized users.
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based access control for course creation.
      allow update: if false; // TODO: Add role-based access control for course updates.
      allow delete: if false; // TODO: Add role-based access control for course deletion.
    }

    /**
     * @description Rules for lessons.
     * @path /lessons/{lessonId}
     * @allow (get) Any user can read lesson data.
     * @allow (list) Any user can list lessons.
     * @deny (create) No users can create lessons (explicit for prototyping).
     * @principle Allows public read access; writes SHOULD be restricted to authorized users.
     */
    match /lessons/{lessonId} {
      allow get, list: if true;
      allow create: if false;  // TODO: Add role-based access control for lesson creation.
      allow update: if false; // TODO: Add role-based access control for lesson updates.
      allow delete: if false; // TODO: Add role-based access control for lesson deletion.
    }

    /**
     * @description Rules for questions.
     * @path /questions/{questionId}
     * @allow (get) Any user can read question data.
     * @allow (list) Any user can list questions.
     * @deny (create) No users can create questions (explicit for prototyping).
     * @principle Allows public read access; writes SHOULD be restricted to authorized users.
     */
    match /questions/{questionId} {
      allow get, list: if true;
      allow create: if false;  // TODO: Add role-based access control for question creation.
      allow update: if false; // TODO: Add role-based access control for question updates.
      allow delete: if false; // TODO: Add role-based access control for question deletion.
    }

    /**
     * @description Rules for exams.
     * @path /exams/{examId}
     * @allow (get) Any user can read exam data.
     * @allow (list) Any user can list exams.
     * @deny (create) No users can create exams (explicit for prototyping).
     * @principle Allows public read access; writes SHOULD be restricted to authorized users.
     */
    match /exams/{examId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based access control for exam creation.
      allow update: if false; // TODO: Add role-based access control for exam updates.
      allow delete: if false; // TODO: Add role-based access control for exam deletion.
    }

    /**
     * @description Rules for attempts.
     * @path /attempts/{attemptId}
     * @allow (get) Any user can read attempt data.
     * @allow (list) Any user can list attempts.
     * @deny (create) No users can create attempts (explicit for prototyping).
     * @principle Allows public read access; writes SHOULD be restricted to authorized users.
     */
    match /attempts/{attemptId} {
      allow get: if true;
      allow list: if true; // The original request had an issue with list permission, enabling `list` for all authenticated users.
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for daily metrics.
     * @path /metrics/daily/{date}
     * @allow (get) Any user can read daily metrics.
     * @allow (list) Any user can list daily metrics.
     * @deny (create) No users can create daily metrics (explicit for prototyping).
     * @principle Allows public read access; writes SHOULD be restricted to authorized users.
     */
    match /metrics/daily/{date} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based access control for metrics creation.
      allow update: if false; // TODO: Add role-based access control for metrics updates.
      allow delete: if false; // TODO: Add role-based access control for metrics deletion.
    }

    /**
     * @description Rules for course competencies.
     * @path /courseCompetencies/{courseCompetencyId}
     * @allow (get) Any user can read course competency data.
     * @allow (list) Any user can list course competencies.
     * @deny (create) No users can create course competencies (explicit for prototyping).
     * @principle Allows public read access; writes SHOULD be restricted to authorized users.
     */
    match /courseCompetencies/{courseCompetencyId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based access control for course competency creation.
      allow update: if false; // TODO: Add role-based access control for course competency updates.
      allow delete: if false; // TODO: Add role-based access control for course competency deletion.
    }

    /**
     * @description Rules for user achievements.
     * @path /users/{userId}/achievements/{userAchievementId}
     * @allow (create) User with UID 'user_abc' can create their achievement if request.auth.uid == 'user_abc'.
     * @deny (create) User with UID 'user_abc' cannot create an achievement for 'user_xyz'.
     * @allow (get) User with UID 'user_abc' can read their achievement at /users/user_abc/achievements/achievement_123.
     * @deny (get) User with UID 'user_abc' cannot read the achievement of /users/user_xyz/achievements/achievement_123.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/achievements/{userAchievementId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

   /**
     * @description Rules for master courses.
     * @path /masterCourses/{masterCourseId}
     * @allow (get) Any user can read master course data.
     * @allow (list) Any user can list master courses.
     * @deny (create) No users can create master courses (explicit for prototyping).
     * @principle Allows public read access; writes SHOULD be restricted to authorized users.
     */
    match /masterCourses/{masterCourseId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based access control for master course creation.
      allow update: if false; // TODO: Add role-based access control for master course updates.
      allow delete: if false; // TODO: Add role-based access control for master course deletion.
    }

    /**
     * @description Rules for master certificates.
     * @path /masterCertificates/{masterCertificateId}
     * @allow (get) Any user can read master certificate data.
     * @allow (list) Any user can list master certificates.
     * @deny (create) No users can create master certificates (explicit for prototyping).
     * @principle Allows public read access; writes SHOULD be restricted to authorized users.
     */
    match /masterCertificates/{masterCertificateId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based access control for master certificate creation.
      allow update: if false; // TODO: Add role-based access control for master certificate updates.
      allow delete: if false; // TODO: Add role-based access control for master certificate deletion.
    }

   /**
     * @description Rules for roadmaps.
     * @path /roadmaps/{roadmapId}
     * @allow (get) Any user can read roadmap data.
     * @allow (list) Any user can list roadmaps.
     * @deny (create) No users can create roadmaps (explicit for prototyping).
     * @principle Allows public read access; writes SHOULD be restricted to authorized users.
     */
    match /roadmaps/{roadmapId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based access control for roadmap creation.
      allow update: if false; // TODO: Add role-based access control for roadmap updates.
      allow delete: if false; // TODO: Add role-based access control for roadmap deletion.
    }

   /**
     * @description Rules for schedules.
     * @path /schedules/{scheduleId}
     * @allow (get) Any user can read schedule data.
     * @allow (list) Any user can list schedules.
     * @deny (create) No users can create schedules (explicit for prototyping).
     * @principle Allows public read access; writes SHOULD be restricted to authorized users.
     */
    match /schedules/{scheduleId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based access control for schedule creation.
      allow update: if false; // TODO: Add role-based access control for schedule updates.
      allow delete: if false; // TODO: Add role-based access control for schedule deletion.
    }

    /**
     * @description Rules for quizzes.
     * @path /quizzes/{quizId}
     * @allow (get) Any user can read quiz data.
     * @allow (list) Any user can list quizzes.
     * @deny (create) No users can create quizzes (explicit for prototyping).
     * @principle Allows public read access; writes SHOULD be restricted to authorized users.
     */
    match /quizzes/{quizId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add role-based access control for quiz creation.
      allow update: if false; // TODO: Add role-based access control for quiz updates.
      allow delete: if false; // TODO: Add role-based access control for quiz deletion.
    }
  }
}