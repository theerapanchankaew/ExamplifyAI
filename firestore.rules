/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user-specific data and allows public read access for certain collections.
 *
 * Data Structure:
 * - Users: `/users/{userId}` - User profiles, owned by the user.
 * - User Achievements: `/users/{userId}/achievements/{achievementId}` - Achievements for a user, owned by the user.
 * - Courses: `/courses/{courseId}` - Publicly readable course data.
 * - Lessons: `/lessons/{lessonId}` - Publicly readable lesson data.
 * - Questions: `/questions/{questionId}` - Publicly readable question data.
 * - Exams: `/exams/{examId}` - Publicly readable exam data.
 * - Attempts: `/attempts/{attemptId}` - Publicly readable attempt data.
 * - Daily Metrics: `/metrics/daily/{date}` - Publicly readable metrics data.
 * - Course Competencies: `/courseCompetencies/{courseCompetencyId}` - Publicly readable course competency data.
 * - Master Courses: `/masterCourses/{masterCourseId}` - Publicly readable master course data.
 * - Master Certificates: `/masterCertificates/{masterCertificateId}` - Publicly readable master certificate data.
 * - Roadmaps: `/roadmaps/{roadmapId}` - Publicly readable roadmap data.
 * - Schedules: `/schedules/{scheduleId}` - Publicly readable schedule data.
 * - Quizzes: `/quizzes/{quizId}` - Publicly readable quiz data.
 *
 * Key Security Decisions:
 * - User data is strictly controlled by the user; only the authenticated user can create, read, update, or delete their own profile and achievements.
 * - All top-level collections such as courses, lessons, questions, exams, attempts, daily metrics, course competencies, master courses, master certificates, roadmaps, schedules and quizzes are publicly readable. Write access is not defined and must be secured later.
 * - Listing of users is disallowed. This protects against unauthorized enumeration of user accounts.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by the authenticated user.
     * @param {string} userId - The user ID to check against.
     * @returns {boolean} True if the user ID matches the authenticated user's UID, false otherwise.
     */
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    /**
     * @description Checks if the request is made by the authenticated user and the resource exists.
     * @param {string} userId - The user ID to check against.
     * @returns {boolean} True if the user ID matches the authenticated user's UID and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description User profiles are only accessible to the authenticated user.
     * @path /users/{userId}
     * @allow (create) - If the user is authenticated and the userId matches the authenticated user's UID.
     * @allow (get, update, delete) - If the user is authenticated and the userId matches the authenticated user's UID.
     * @deny (create) - If the user is not authenticated or the userId does not match the authenticated user's UID.
     * @deny (get, update, delete) - If the user is not authenticated or the userId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores user achievements. Accessible only by the user.
     * @path /users/{userId}/achievements/{userAchievementId}
     * @allow (create) - If the user is authenticated and the userId matches the authenticated user's UID.
     * @allow (get, update, delete) - If the user is authenticated and the userId matches the authenticated user's UID.
     * @deny (create) - If the user is not authenticated or the userId does not match the authenticated user's UID.
     * @deny (get, update, delete) - If the user is not authenticated or the userId does not match the authenticated user's UID.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/achievements/{userAchievementId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Stores course information.
     * @path /courses/{courseId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access is allowed.
     * @principle Public read access with no write access control.
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores lesson information, related to a course by `courseId`.
     * @path /lessons/{lessonId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access is allowed.
     * @principle Public read access with no write access control.
     */
    match /lessons/{lessonId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores questions for exams and quizzes.
     * @path /questions/{questionId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access is allowed.
     * @principle Public read access with no write access control.
     */
    match /questions/{questionId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores exam definitions, related to a course by `courseId`.
     * @path /exams/{examId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access is allowed.
     * @principle Public read access with no write access control.
     */
    match /exams/{examId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores user exam attempts, linked to a user by `userId` and an exam by `examId`.
     * @path /attempts/{attemptId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access is allowed.
     * @principle Public read access with no write access control.
     */
    match /attempts/{attemptId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores daily metrics for the system. Document ID is the date in YYYYMMDD format.
     * @path /metrics/daily/{date}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access is allowed.
     * @principle Public read access with no write access control.
     */
    match /metrics/daily/{date} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores the mapping between courses and competencies.
     * @path /courseCompetencies/{courseCompetencyId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access is allowed.
     * @principle Public read access with no write access control.
     */
    match /courseCompetencies/{courseCompetencyId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores master course definitions.
     * @path /masterCourses/{masterCourseId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access is allowed.
     * @principle Public read access with no write access control.
     */
    match /masterCourses/{masterCourseId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores issued master certificates, linked to a user by `userId` and a master course by `masterCourseId`.
     * @path /masterCertificates/{masterCertificateId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access is allowed.
     * @principle Public read access with no write access control.
     */
    match /masterCertificates/{masterCertificateId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores roadmap definitions.
     * @path /roadmaps/{roadmapId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access is allowed.
     * @principle Public read access with no write access control.
     */
    match /roadmaps/{roadmapId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores schedule events.
     * @path /schedules/{scheduleId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access is allowed.
     * @principle Public read access with no write access control.
     */
    match /schedules/{scheduleId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Stores quiz information.
     * @path /quizzes/{quizId}
     * @allow (get, list) - Public read access.
     * @deny (create, update, delete) - No write access is allowed.
     * @principle Public read access with no write access control.
     */
    match /quizzes/{quizId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }
  }
}