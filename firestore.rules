/**
 * @file Firestore Security Rules for ExamplifyAI
 * @version Prototype - Strict authorization with flexible data shapes.
 *
 * @Core Philosophy: This ruleset prioritizes strong authorization based on user roles and ownership while minimizing data validation to allow for rapid prototyping.  Schema enforcement is intentionally light.
 * @Data Structure: The Firestore data model includes top-level collections for Courses, Lessons, Exams, Questions, etc., and user-specific subcollections under `/users/{userId}`.
 * @Key Security Decisions:
 *  - User data under `/users/{userId}` is strictly controlled, accessible only to the owning user and admins.
 *  - Public read access is granted to Courses, Lessons, Exams and Questions collections to facilitate open content browsing. Writes to these collections are restricted to signed-in users.
 *  - Attempts collection now uses correct user-based ownership.
 * @Denormalization for Authorization: The 'Attempt' entity contains a `userId` field to facilitate ownership checks, preventing the need for complex queries.
 * @Structural Segregation: User-specific private data (e.g., achievements) is stored in subcollections under `/users/{userId}`, separate from public data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== Helper Functions ====================
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isSignedIn() && resource.data.userId == request.auth.uid;
    }

    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ==================== Users Collection ====================
    /**
     * @description Controls access to user profiles. Only the user and admins can read/write their own profile data.
     * @path /users/{userId}
     * @allow (get, update, delete) if request.auth.uid == userId: Allows the user to read, update, and delete their own profile.
     * @allow (create) if request.auth.uid == userId: Allows a user to create their profile during sign-up.
     * @deny (get, update, delete) if request.auth.uid != userId: Denies access to other users' profiles.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false; // Prevent listing all users
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isOwner(userId) || isAdmin();

      // ==================== User Achievements Sub-collection ====================
      /**
       * @description Restricts access to user achievements. Only the owner and admins can read/write.
       * @path /users/{userId}/achievements/{achievementId}
       * @allow (read, write) if request.auth.uid == userId: Allows the user to read and write their own achievements.
       * @deny (read, write) if request.auth.uid != userId: Denies access to other users' achievements.
       * @principle Restricts access to a user's own data tree.
       */
      match /achievements/{achievementId} {
        allow get: if isOwner(userId);
        allow list: if false;
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      // ==================== User Settings Sub-collection ====================
      /**
       * @description Restricts access to user settings. Only the owner can read/write.
       * @path /users/{userId}/settings/{settingId}
       * @allow (read, write) if request.auth.uid == userId: Allows the user to read and write their own settings.
       * @deny (read, write) if request.auth.uid != userId: Denies access to other users' settings.
       * @principle Restricts access to a user's own data tree.
       */
      match /settings/{settingId} {
        allow get: if isOwner(userId);
        allow list: if false;
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      // ==================== User Progress Sub-collection ====================
      /**
       * @description Restricts access to user progress. Only the owner can read/write.
       * @path /users/{userId}/progress/{progressId}
       * @allow (read, write) if request.auth.uid == userId: Allows the user to read and write their own progress.
       * @deny (read, write) if request.auth.uid != userId: Denies access to other users' progress.
       * @principle Restricts access to a user's own data tree.
       */
      match /progress/{progressId} {
        allow get: if isOwner(userId);
        allow list: if false;
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
    }

    // ==================== Courses Collection ====================
    /**
     * @description Allows public read access to course information, but restricts write access to signed-in users.
     * @path /courses/{courseId}
     * @allow (get, list) if true: Allows anyone to read course data.
     * @allow (create, update, delete) if isSignedIn(): Allows signed-in users to modify course data.
     * @principle Provides public read access while restricting writes.
     */
    match /courses/{courseId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ==================== Lessons Collection ====================
    /**
     * @description Allows public read access to lesson information, but restricts write access to signed-in users.
     * @path /lessons/{lessonId}
     * @allow (get, list) if true: Allows anyone to read lesson data.
     * @allow (create, update, delete) if isSignedIn(): Allows signed-in users to modify lesson data.
     * @principle Provides public read access while restricting writes.
     */
    match /lessons/{lessonId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ==================== Modules Collection ====================
    /**
     * @description Allows public read access to module information, but restricts write access to signed-in users.
     * @path /modules/{moduleId}
     * @allow (get, list) if true: Allows anyone to read module data.
     * @allow (create, update, delete) if isSignedIn(): Allows signed-in users to modify module data.
     * @principle Provides public read access while restricting writes.
     */
    match /modules/{moduleId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ==================== Chapters Collection ====================
    /**
     * @description Allows public read access to chapter information, but restricts write access to signed-in users.
     * @path /chapters/{chapterId}
     * @allow (get, list) if true: Allows anyone to read chapter data.
     * @allow (create, update, delete) if isSignedIn(): Allows signed-in users to modify chapter data.
     * @principle Provides public read access while restricting writes.
     */
    match /chapters/{chapterId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ==================== Questions Collection ====================
    /**
     * @description Allows public read access to question information, but restricts write access to signed-in users.
     * @path /questions/{questionId}
     * @allow (get, list) if true: Allows anyone to read question data.
     * @allow (create, update, delete) if isSignedIn(): Allows signed-in users to modify question data.
     * @principle Provides public read access while restricting writes.
     */
    match /questions/{questionId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ==================== Exams Collection ====================
    /**
     * @description Allows public read access to exam information, but restricts write access to signed-in users.
     * @path /exams/{examId}
     * @allow (get, list) if true: Allows anyone to read exam data.
     * @allow (create, update, delete) if isSignedIn(): Allows signed-in users to modify exam data.
     * @principle Provides public read access while restricting writes.
     */
    match /exams/{examId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ==================== Attempts Collection ====================
    /**
     * @description Controls access to exam attempts.  Users can only create attempts for themselves, and can only read/write their own attempts.
     * @path /attempts/{attemptId}
     * @allow (get) if request.auth.uid == resource.data.userId: Allows a user to read their own attempt.
     * @allow (create) if request.auth.uid == request.resource.data.userId: Allows a user to create an attempt for themselves.
     * @allow (update, delete) if request.auth.uid == resource.data.userId: Allows a user to update/delete their own attempt.
     * @deny (get, create, update, delete) if request.auth.uid != resource.data.userId: Denies access to other users' attempts.
     * @principle Enforces document ownership for exam attempts.
     */
    match /attempts/{attemptId} {
        allow get: if isSignedIn() && resource.data.userId == request.auth.uid;
        allow list: if false;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
        allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // ==================== Metrics Collection ====================
    /**
     * @description Controls access to daily metrics.  Currently allows any signed-in user to read, and any signed-in user to create.
     * @path /metrics/daily/{date}
     * @allow (get, list) if isSignedIn(): Allows a user to read the daily metrics.
     * @allow (create) if isSignedIn(): Allows a user to create the daily metrics.
     * @principle Requires authentication for reading and creating metrics.
     */
    match /metrics/{metricType} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();

      match /daily/{date} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
       match /monthly/{month} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }

   // ==================== Course Competencies Collection ====================
    /**
     * @description Allows public read access to course competencies, but restricts write access to signed-in users.
     * @path /courseCompetencies/{courseCompetencyId}
     * @allow (get, list) if true: Allows anyone to read course competency data.
     * @allow (create, update, delete) if isSignedIn(): Allows signed-in users to modify course competency data.
     * @principle Provides public read access while restricting writes.
     */
   match /courseCompetencies/{competencyId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

     // ==================== Master Courses Collection ====================
    /**
     * @description Allows public read access to master courses, but restricts write access to signed-in users.
     * @path /masterCourses/{masterCourseId}
     * @allow (get, list) if true: Allows anyone to read master course data.
     * @allow (create, update, delete) if isSignedIn(): Allows signed-in users to modify master course data.
     * @principle Provides public read access while restricting writes.
     */
    match /masterCourses/{masterCourseId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();

         // ✅ Master Course Lessons Sub-collection
      match /lessons/{lessonId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }

    // ==================== Master Certificates Collection ====================
    /**
     * @description Allows public read access to master certificates, but restricts write access to signed-in users.
     * @path /masterCertificates/{masterCertificateId}
     * @allow (get, list) if true: Allows anyone to read master certificate data.
     * @allow (create, update, delete) if isSignedIn(): Allows signed-in users to modify master certificate data.
     * @principle Provides public read access while restricting writes.
     */
    match /masterCertificates/{masterCertificateId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

     // ==================== Roadmaps Collection ====================
    /**
     * @description Allows public read access to roadmaps, but restricts write access to signed-in users.
     * @path /roadmaps/{roadmapId}
     * @allow (get, list) if true: Allows anyone to read roadmap data.
     * @allow (create, update, delete) if isSignedIn(): Allows signed-in users to modify roadmap data.
     * @principle Provides public read access while restricting writes.
     */
    match /roadmaps/{roadmapId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();

      // ✅ Roadmap Milestones Sub-collection
      match /milestones/{milestoneId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }

     // ==================== Schedules Collection ====================
    /**
     * @description Allows public read access to schedules, but restricts write access to signed-in users.
     * @path /schedules/{scheduleId}
     * @allow (get, list) if true: Allows anyone to read schedule data.
     * @allow (create, update, delete) if isSignedIn(): Allows signed-in users to modify schedule data.
     * @principle Provides public read access while restricting writes.
     */
    match /schedules/{scheduleId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

     // ==================== Quizzes Collection ====================
    /**
     * @description Allows public read access to quizzes, but restricts write access to signed-in users.
     * @path /quizzes/{quizId}
     * @allow (get, list) if true: Allows anyone to read quiz data.
     * @allow (create, update, delete) if isSignedIn(): Allows signed-in users to modify quiz data.
     * @principle Provides public read access while restricting writes.
     */
    match /quizzes/{quizId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();

      // ✅ Quiz Questions Sub-collection
      match /questions/{questionId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }

      // ✅ Quiz Submissions Sub-collection
        match /submissions/{submissionId} {
        allow get: if isSignedIn() && resource.data.userId == request.auth.uid;
        allow list: if false;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if isSignedIn() && resource.data.userId == request.auth.uid || isAdmin();
        allow delete: if isAdmin();
      }
    }
  }
}