rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the document.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the request is made by the existing owner of the document, ensuring the document exists.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource.data.userId == request.auth.uid;
    }

    /**
     * @description Rules for the /users/{userId} collection.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (create) User with UID 'test_user' can create their own profile.
     * @allow (get) User with UID 'test_user' can read their own profile.
     * @deny (create) User with UID 'test_user' cannot create a profile for another user.
     * @deny (get) User with UID 'another_user' cannot read the 'test_user' profile.
     * @principle Enforces document ownership for writes; allows owner-only access.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for the /courses/{courseId} collection.
     * @path /databases/{database}/documents/courses/{courseId}
     * @allow (get) Any user can read course information.
     * @allow (list) Any user can list courses.
     * @deny (create) No one can create courses without authorization logic.
     * @principle Allows public read access; requires authorization for writes.
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // Only signed-in users can create courses.
      allow update: if isSignedIn(); // TODO: Add authorization logic for course updates (e.g., admin or instructor role).
      allow delete: if isSignedIn(); // TODO: Add authorization logic for course deletion (e.g., admin role).
    }

    /**
     * @description Rules for the /lessons/{lessonId} collection.
     * @path /databases/{database}/documents/lessons/{lessonId}
     * @allow (get) Any user can read lesson information.
     * @allow (list) Any user can list lessons.
     * @deny (create) No one can create lessons without authorization logic.
     * @principle Allows public read access; requires authorization for writes.
     */
    match /lessons/{lessonId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // Only signed-in users can create lessons.
      allow update: if isSignedIn(); // TODO: Add authorization logic for lesson updates (e.g., admin or instructor role).
      allow delete: if isSignedIn(); // TODO: Add authorization logic for lesson deletion (e.g., admin role).
    }

    /**
     * @description Rules for the /modules/{moduleId} collection.
     * @path /databases/{database}/documents/modules/{moduleId}
     * @allow (get) Any user can read module information.
     * @allow (list) Any user can list modules.
     * @deny (create) No one can create modules without authorization logic.
     * @principle Allows public read access; requires authorization for writes.
     */
    match /modules/{moduleId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // Only signed-in users can create modules.
      allow update: if isSignedIn(); // TODO: Add authorization logic for module updates (e.g., admin or instructor role).
      allow delete: if isSignedIn(); // TODO: Add authorization logic for module deletion (e.g., admin role).
    }

    /**
     * @description Rules for the /chapters/{chapterId} collection.
     * @path /databases/{database}/documents/chapters/{chapterId}
     * @allow (get) Any user can read chapter information.
     * @allow (list) Any user can list chapters.
     * @deny (create) No one can create chapters without authorization logic.
     * @principle Allows public read access; requires authorization for writes.
     */
    match /chapters/{chapterId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // Only signed-in users can create chapters.
      allow update: if isSignedIn(); // TODO: Add authorization logic for chapter updates (e.g., admin or instructor role).
      allow delete: if isSignedIn(); // TODO: Add authorization logic for chapter deletion (e.g., admin role).
    }

    /**
     * @description Rules for the /questions/{questionId} collection.
     * @path /databases/{database}/documents/questions/{questionId}
     * @allow (get) Any user can read question information.
     * @allow (list) Any user can list questions.
     * @deny (create) No one can create questions without authorization logic.
     * @principle Allows public read access; requires authorization for writes.
     */
    match /questions/{questionId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // Only signed-in users can create questions.
      allow update: if isSignedIn(); // TODO: Add authorization logic for question updates (e.g., admin or instructor role).
      allow delete: if isSignedIn(); // TODO: Add authorization logic for question deletion (e.g., admin role).
    }

    /**
     * @description Rules for the /exams/{examId} collection.
     * @path /databases/{database}/documents/exams/{examId}
     * @allow (get) Any user can read exam information.
     * @allow (list) Any user can list exams.
     * @deny (create) No one can create exams without authorization logic.
     * @principle Allows public read access; requires authorization for writes.
     */
    match /exams/{examId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // Only signed-in users can create exams.
      allow update: if isSignedIn(); // TODO: Add authorization logic for exam updates (e.g., admin or instructor role).
      allow delete: if isSignedIn(); // TODO: Add authorization logic for exam deletion (e.g., admin role).
    }

    /**
     * @description Rules for the /attempts/{attemptId} collection.
     * @path /databases/{database}/documents/attempts/{attemptId}
     * @allow (get) Any user can read attempt information.
     * @allow (list) Any user can list attempts.
     * @deny (create) No one can create attempts without authorization logic.
     * @principle Allows public read access; requires authorization for writes.
     */
    match /attempts/{attemptId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // Only signed-in users can create attempts.
      allow update: if request.auth.uid == resource.data.userId; // TODO: Add authorization logic for attempt updates (e.g., user-specific).
      allow delete: if request.auth.uid == resource.data.userId; // TODO: Add authorization logic for attempt deletion (e.g., admin or user-specific).
    }

    /**
     * @description Rules for the /metrics/daily/{date} collection.
     * @path /databases/{database}/documents/metrics/daily/{date}
     * @allow (get) Any user can read daily metrics.
     * @allow (list) Any user can list daily metrics.
     * @deny (create) No one can create daily metrics without authorization logic.
     * @principle Allows public read access; requires authorization for writes.
     */
    match /metrics/daily/{date} {
      allow get, list: if true;
      allow create: if false; // TODO: Add authorization logic for metrics creation (e.g., admin role).
      allow update: if false; // TODO: Add authorization logic for metrics updates (e.g., admin role).
      allow delete: if false; // TODO: Add authorization logic for metrics deletion (e.g., admin role).
    }

    /**
     * @description Rules for the /courseCompetencies/{courseCompetencyId} collection.
     * @path /databases/{database}/documents/courseCompetencies/{courseCompetencyId}
     * @allow (get) Any user can read course competency information.
     * @allow (list) Any user can list course competencies.
     * @deny (create) No one can create course competencies without authorization logic.
     * @principle Allows public read access; requires authorization for writes.
     */
    match /courseCompetencies/{courseCompetencyId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // Only signed-in users can create course competencies.
      allow update: if isSignedIn(); // TODO: Add authorization logic for course competency updates (e.g., admin or instructor role).
      allow delete: if isSignedIn(); // TODO: Add authorization logic for course competency deletion (e.g., admin role).
    }

    /**
     * @description Rules for the /users/{userId}/achievements/{userAchievementId} collection.
     * @path /databases/{database}/documents/users/{userId}/achievements/{userAchievementId}
     * @allow (create) User with UID 'test_user' can create their own achievement.
     * @allow (get) User with UID 'test_user' can read their own achievement.
     * @deny (create) User with UID 'test_user' cannot create an achievement for another user.
     * @deny (get) User with UID 'another_user' cannot read the 'test_user' achievement.
     * @principle Enforces document ownership for writes; allows owner-only access.
     */
    match /users/{userId}/achievements/{userAchievementId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for the /masterCourses/{masterCourseId} collection.
     * @path /databases/{database}/documents/masterCourses/{masterCourseId}
     * @allow (get) Any user can read master course information.
     * @allow (list) Any user can list master courses.
     * @deny (create) No one can create master courses without authorization logic.
     * @principle Allows public read access; requires authorization for writes.
     */
    match /masterCourses/{masterCourseId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // Only signed-in users can create master courses.
      allow update: if isSignedIn(); // TODO: Add authorization logic for master course updates (e.g., admin role).
      allow delete: if isSignedIn(); // TODO: Add authorization logic for master course deletion (e.g., admin role).
    }

    /**
     * @description Rules for the /masterCertificates/{masterCertificateId} collection.
     * @path /databases/{database}/documents/masterCertificates/{masterCertificateId}
     * @allow (get) Any user can read master certificate information.
     * @allow (list) Any user can list master certificates.
     * @deny (create) No one can create master certificates without authorization logic.
     * @principle Allows public read access; requires authorization for writes.
     */
    match /masterCertificates/{masterCertificateId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // Only signed-in users can create master certificates.
      allow update: if isSignedIn(); // TODO: Add authorization logic for master certificate updates (e.g., admin role).
      allow delete: if isSignedIn(); // TODO: Add authorization logic for master certificate deletion (e.g., admin role).
    }

    /**
     * @description Rules for the /roadmaps/{roadmapId} collection.
     * @path /databases/{database}/documents/roadmaps/{roadmapId}
     * @allow (get) Any user can read roadmap information.
     * @allow (list) Any user can list roadmaps.
     * @deny (create) No one can create roadmaps without authorization logic.
     * @principle Allows public read access; requires authorization for writes.
     */
    match /roadmaps/{roadmapId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // Only signed-in users can create roadmaps.
      allow update: if isSignedIn(); // TODO: Add authorization logic for roadmap updates (e.g., admin role).
      allow delete: if isSignedIn(); // TODO: Add authorization logic for roadmap deletion (e.g., admin role).
    }

    /**
     * @description Rules for the /schedules/{scheduleId} collection.
     * @path /databases/{database}/documents/schedules/{scheduleId}
     * @allow (get) Any user can read schedule information.
     * @allow (list) Any user can list schedules.
     * @deny (create) No one can create schedules without authorization logic.
     * @principle Allows public read access; requires authorization for writes.
     */
    match /schedules/{scheduleId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // Only signed-in users can create schedules.
      allow update: if isSignedIn(); // TODO: Add authorization logic for schedule updates (e.g., admin or instructor role).
      allow delete: if isSignedIn(); // TODO: Add authorization logic for schedule deletion (e.g., admin role).
    }

     /**
     * @description Rules for the /quizzes/{quizId} collection.
     * @path /databases/{database}/documents/quizzes/{quizId}
     * @allow (get) Any user can read quiz information.
     * @allow (list) Any user can list quizzes.
     * @deny (create) No one can create quizzes without authorization logic.
     * @principle Allows public read access; requires authorization for writes.
     */
    match /quizzes/{quizId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // Only signed-in users can create quizzes.
      allow update: if isSignedIn(); // TODO: Add authorization logic for quiz updates (e.g., admin or instructor role).
      allow delete: if isSignedIn(); // TODO: Add authorization logic for quiz deletion (e.g., admin role).
    }
  }
}